<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-11-17 Fri 09:52 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org4b3af93">1. task</a></li>
<li><a href="#orgb85d571">2. exploring</a>
<ul>
<li><a href="#org2aed69e">2.1. interview.X.csv</a></li>
<li><a href="#org580b039">2.2. interview.y.csv</a></li>
<li><a href="#orgec0a87e">2.3. connection by uid</a></li>
<li><a href="#org04c1b9c">2.4. explore interview.X.csv connection by uid</a></li>
<li><a href="#org1442ce6">2.5. How meny uids repeats?</a></li>
<li><a href="#org986e433">2.6. count empty or na</a></li>
<li><a href="#org66ddfaa">2.7. fclick</a></li>
</ul>
</li>
<li><a href="#org7d43a2a">3. correlation analysis</a>
<ul>
<li><a href="#orgb2c838f">3.1. "no tag" vs "with tags" x7</a></li>
<li><a href="#org4ebf17d">3.2. "with tags" vs tag == 'fclick'</a></li>
<li><a href="#org4bf690c">3.3. "with tags" vs tag == 'vregistration'</a></li>
<li><a href="#orgb642359">3.4. "with tags" vs tag == 'registration'</a></li>
<li><a href="#org01b06c2">3.5. "with tags" vs tag == 'vcontent'</a></li>
<li><a href="#org290aad7">3.6. "with tags" vs tag == 'vsignup'</a></li>
<li><a href="#orgc27c978">3.7. "with tags" vs tag == 'vmisc'</a></li>
<li><a href="#org4a6ba0c">3.8. "with tags" vs tag == 'vlead'</a></li>
<li><a href="#org74f6cb9">3.9. "with tags" vs tag == 'signup'</a></li>
<li><a href="#orgafbec5b">3.10. "with tags" vs tag == 'misc'</a></li>
<li><a href="#org7669009">3.11. "with tags" vs tag == 'lead'</a></li>
<li><a href="#orgfb79505">3.12. "with tags" vs tag == 'content'</a></li>
</ul>
</li>
<li><a href="#org80c1ed4">4. prediction</a>
<ul>
<li><a href="#orge27e97a">4.1. prepare data</a></li>
<li><a href="#orgaac5e76">4.2. zero classifier</a></li>
<li><a href="#org69078e0">4.3. oversampling with SMOTE</a></li>
<li><a href="#org9cb6ced">4.4. zero classifier for oversampled</a></li>
<li><a href="#org452d119">4.5. selection of metric</a></li>
<li><a href="#org7b976b5">4.6. correlation analysis + Variance Inflation Factor</a></li>
<li><a href="#org4ae4d9f">4.7. seletion of model</a>
<ul>
<li><a href="#orgba9b4ec">4.7.1. Algorithm to choose from:</a></li>
<li><a href="#org102a5c2">4.7.2. criterions:</a></li>
<li><a href="#org0b6f1ab">4.7.3. multicollinearity criterion</a></li>
<li><a href="#org98d8810">4.7.4. experiments</a></li>
<li><a href="#org55c6275">4.7.5. result</a></li>
</ul>
</li>
<li><a href="#org289329d">4.8. model finetuning and training</a></li>
<li><a href="#orgaa862c0">4.9. test or validation of model</a></li>
<li><a href="#orge35fdcc">4.10. model output calibration</a></li>
<li><a href="#orgc0f8d22">4.11. test calibrated</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org4b3af93" class="outline-2">
<h2 id="org4b3af93"><span class="section-number-2">1.</span> task</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="Interview.test-task 1, 2.pdf">Interview.test-task 1, 2.pdf</a>
</p>

<p>
<a href="https://hh.ru/vacancy/87948954?hhtmFrom=chat">https://hh.ru/vacancy/87948954?hhtmFrom=chat</a>
</p>

<p>
<a href="https://chatik.hh.ru/chat/3482754117">https://chatik.hh.ru/chat/3482754117</a>
</p>

<p>
Python программист-разработчик – Python Developer <a href="https://hh.ru/vacancy/87948954">https://hh.ru/vacancy/87948954</a>
</p>

<p>
AllmaGen
США allmagen.com
</p>
</div>
</div>
<div id="outline-container-orgb85d571" class="outline-2">
<h2 id="orgb85d571"><span class="section-number-2">2.</span> exploring</h2>
<div class="outline-text-2" id="text-2">
<p>
interview.X.csv and interview.y.csv - показы и события.
</p>
</div>
<div id="outline-container-org2aed69e" class="outline-3">
<h3 id="org2aed69e"><span class="section-number-3">2.1.</span> interview.X.csv</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> explore_sparse_classes

<span style="color: #cae682;">df</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #e5786d;">print</span>(df.head(5).to_string())
<span style="color: #e5786d;">print</span>(df.tail(5).to_string())
describe(df)
explore_sparse_classes(df)
</pre>
</div>

<pre class="example" id="org17abfd3">
              reg_time                                   uid  fc_imp_chk  fc_time_chk  utmtr  mm_dma   osName      model      hardware                         site_id
0  2021-07-21 19:25:47  00000000-0000-0001-6268-955448351062           0            7      6     530      iOS  iPhone XR  Mobile Phone              soaps.sheknows.com
1  2021-07-21 19:25:51  00000000-0000-0001-6268-955448381600           0            7      6     612      iOS     iPhone  Mobile Phone                  www.forbes.com
2  2021-07-21 19:25:52  00000000-0000-0001-6268-955460621935           0            7      6     524  Android   SM-G998U  Mobile Phone                 www.parents.com
3  2021-07-21 19:26:05  00000000-0000-0001-6268-955631601064           0            7      6     659      iOS     iPhone  Mobile Phone        livingforthesunshine.com
4  2021-07-21 19:26:05  00000000-0000-0001-6268-955659731502           0            7      6     505      iOS     iPhone  Mobile Phone  www.pro-football-reference.com
                   reg_time                                   uid  fc_imp_chk  fc_time_chk  utmtr  mm_dma   osName     model      hardware                  site_id
955234  2021-08-06 20:25:03  00000000-0000-0001-6282-518776541959           1            6      4     524      iOS    iPhone  Mobile Phone      www.forsythnews.com
955235  2021-08-07 02:04:56  00000000-0000-0001-6283-018960011814           0            7      0     524  Android  SM-N986U  Mobile Phone  currently.att.yahoo.com
955236  2021-08-09 00:47:42  00000000-0000-0001-6284-700631301210           0            7      0       0  Android  SM-N986U  Mobile Phone         www.ladbible.com
955237  2021-08-09 02:48:05  00000000-0000-0001-6284-772865041722           0            7      0       0      iOS    iPhone  Mobile Phone         www.ladbible.com
955238  2021-08-09 02:48:05  00000000-0000-0001-6284-772863251200           0            7      0       0      iOS    iPhone  Mobile Phone         www.ladbible.com
          fc_imp_chk    fc_time_chk          utmtr         mm_dma
count  955239.000000  955239.000000  955239.000000  955239.000000
mean        0.185832       6.914158       3.258058     523.416025
std         0.715118       0.280967       2.372753     130.622881
min        -1.000000      -1.000000       0.000000       0.000000
25%         0.000000       7.000000       1.000000     505.000000
50%         0.000000       7.000000       3.000000     524.000000
75%         0.000000       7.000000       5.000000     567.000000
max         4.000000       7.000000       7.000000     881.000000
                   reg_time                                   uid  osName   model      hardware              site_id
count                955239                                955239  947347  946844        947054               955239
unique               640973                                954978      11    1480             8                11290
top     2021-07-26 01:34:52  00000000-0000-0001-6271-783482221787     iOS  iPhone  Mobile Phone  www.dailymotion.com
freq                     10                                     5  712232  622333        946415               150709
reg_time       object
uid            object
fc_imp_chk      int64
fc_time_chk     int64
utmtr           int64
mm_dma          int64
osName         object
model          object
hardware       object
site_id        object
dtype: object
reg_time total features: 640973
percent 1 records: 9552 categories: 640973
features lower percent 640973
2021-07-26 01:34:52    0.001047
2021-08-05 01:20:24    0.000942
2021-08-04 00:24:04    0.000942
2021-07-22 10:55:03    0.000942
2021-07-22 10:17:48    0.000942
2021-07-30 00:15:38    0.000942
2021-07-22 11:47:39    0.000942
2021-07-24 01:33:48    0.000837
2021-07-31 00:15:47    0.000837
2021-07-26 00:16:22    0.000837
2021-07-27 00:43:53    0.000837
2021-07-22 10:39:20    0.000837
2021-08-06 06:57:27    0.000837
2021-07-27 01:00:26    0.000837
2021-07-22 10:39:55    0.000837
2021-08-04 18:32:48    0.000837
2021-07-30 00:11:40    0.000837
2021-07-24 02:09:47    0.000837
2021-08-03 01:53:52    0.000837
2021-07-30 00:20:31    0.000837

uid total features: 954978
percent 1 records: 9552 categories: 954978
features lower percent 954978
00000000-0000-0001-6271-783482221787    0.000523
00000000-0000-0001-6279-596848711124    0.000314
00000000-0000-0001-6275-961133851702    0.000314
00000000-0000-0001-6280-827379751066    0.000314
00000000-0000-0001-6274-462908321857    0.000314
00000000-0000-0001-6275-466475421332    0.000314
00000000-0000-0001-6274-878811161019    0.000314
00000000-0000-0001-6269-611911211679    0.000209
00000000-0000-0001-6270-087630661691    0.000209
00000000-0000-0001-6273-627241261195    0.000209
00000000-0000-0001-6278-143043971816    0.000209
00000000-0000-0001-6271-850071761181    0.000209
00000000-0000-0001-6273-932128981384    0.000209
00000000-0000-0001-6274-632755191309    0.000209
00000000-0000-0001-6276-734908821349    0.000209
00000000-0000-0001-6268-962454071260    0.000209
00000000-0000-0001-6280-978976721051    0.000209
00000000-0000-0001-6278-654917821841    0.000209
00000000-0000-0001-6278-551412201752    0.000209
00000000-0000-0001-6275-193265761180    0.000209

osName total features: 11
iOS            75.181744
Android        24.793238
Windows 10      0.018789
Windows 7       0.001794
Tizen           0.001583
Symbian         0.001372
Linux           0.000739
Windows 8.1     0.000211
Windows XP      0.000211
OS X            0.000211
KaiOS           0.000106

model total features: 1480
percent 1 records: 9552 categories: 1477
features lower percent 1477
iPhone               65.727089
iPhone 11             1.682748
iPhone XR             1.216673
iPhone 12 Pro Max     0.887686
SM-G973U              0.827275
SM-G991U              0.812277
iPhone 12             0.753873
SM-G960U              0.749226
SM-G975U              0.712367
SM-G970U              0.703178
iPhone 11 Pro Max     0.672339
iPhone 8 Plus         0.586263
SM-G998U              0.578554
iPhone 12 Pro         0.547820
iPhone 8              0.485719
SM-N986U              0.474841
SM-G965U              0.464702
SM-N960U              0.458259
SM-N975U              0.448332
Pixel 4a              0.417703

hardware total features: 8
Mobile Phone                99.932528
Media Player                 0.041814
Desktop                      0.021963
Refrigerator                 0.001584
Mobile+Phone                 0.000845
Tablet                       0.000634
Data Collection Terminal     0.000528
Digital Home Assistant       0.000106

site_id total features: 11290
percent 1 records: 9552 categories: 11278
features lower percent 11278
www.dailymotion.com         15.777099
whatculture.com             10.717527
nypost.com                   7.753348
www.digitalspy.com           2.971508
www.yahoo.com                1.992800
people.com                   1.791384
my.xfinity.com               1.665552
myfox8.com                   1.620956
www.elle.com                 1.606195
finance.yahoo.com            1.312132
www.stltoday.com             1.201898
www.foxbusiness.com          1.005822
www.wowhead.com              0.915268
currently.att.yahoo.com      0.756669
metropcs.mobileposse.com     0.747038
news.yahoo.com               0.731754
www.woodtv.com               0.697522
tbc.wowhead.com              0.666221
hu.motorsport.com            0.654077
thespun.com                  0.619531
</pre>
</div>
</div>

<div id="outline-container-org580b039" class="outline-3">
<h3 id="org580b039"><span class="section-number-3">2.2.</span> interview.y.csv</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> explore_sparse_classes
<span style="color: #cae682;">df</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.head(5).to_string())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.tail(5).to_string())</span>
describe(df)
explore_sparse_classes(df)
</pre>
</div>

<pre class="example" id="org6e9502a">
                                         uid            tag
count                                  15359          15359
unique                                  9661             11
top     00000000-0000-0001-6269-125248461755  vregistration
freq                                      20           6340
                                         uid            tag
count                                  15359          15359
unique                                  9661             11
top     00000000-0000-0001-6269-125248461755  vregistration
freq                                      20           6340
uid    object
tag    object
dtype: object
uid total features: 9661
percent 1 records: 154 categories: 9661
features lower percent 9661
00000000-0000-0001-6269-125248461755    0.130217
00000000-0000-0001-6269-728114091454    0.110684
00000000-0000-0001-6269-928102541212    0.065108
00000000-0000-0001-6277-863996211392    0.058598
00000000-0000-0001-6273-182905651400    0.045576
00000000-0000-0001-6269-481304751725    0.045576
00000000-0000-0001-6278-353911501092    0.045576
00000000-0000-0001-6270-532216211741    0.045576
00000000-0000-0001-6274-785161591911    0.039065
00000000-0000-0001-6270-486004111650    0.039065
00000000-0000-0001-6272-697065271970    0.039065
00000000-0000-0001-6270-543462391381    0.039065
00000000-0000-0001-6274-383563711482    0.039065
00000000-0000-0001-6279-929464491375    0.039065
00000000-0000-0001-6269-035657391606    0.039065
00000000-0000-0001-6269-704868931197    0.039065
00000000-0000-0001-6276-877153691916    0.039065
00000000-0000-0001-6271-334367641288    0.039065
00000000-0000-0001-6270-515750861306    0.039065
00000000-0000-0001-6270-449607921642    0.039065

tag total features: 11
vregistration    41.278729
registration     27.104629
fclick           25.665733
vcontent          3.274953
vsignup           1.608178
vlead             0.429715
vmisc             0.299499
signup            0.175793
content           0.110684
misc              0.026043
lead              0.026043

</pre>
</div>
</div>

<div id="outline-container-orgec0a87e" class="outline-3">
<h3 id="orgec0a87e"><span class="section-number-3">2.3.</span> connection by uid</h3>
<div class="outline-text-3" id="text-2-3">
<p>
X.csv is large, we will take a part of it
</p>

<p>
We can see that
</p>
<ul class="org-ul">
<li>Uid is uniqie in X.csv. One uid have several tags.</li>
<li>0.001 of X.csv have corresponding record in y.csv</li>
<li>every uid in X have only one tag in y.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">import</span> numpy <span style="color: #8ac6f2; font-weight: bold;">as</span> np
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> count_fkey

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.02, random_state=42)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"dfx.shape"</span>, dfx.shape)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"-- dfx.uid, dfy.uid:"</span>)
count_fkey(dfx.uid, dfy.uid)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"-- dfy.uid, dfx.uid:"</span>)
count_fkey(dfy.uid, dfx.uid)
</pre>
</div>

<pre class="example" id="org7747bab">
dfx.shape (19105, 10)
-- dfx.uid, dfy.uid:
Count of unique values of the first key and count of values in the second key:
[uid]: 19105
[uid]: 12477
True is values of the first key that exist in the second key:
   values  count
0   False  18911
1    True    194
-- dfy.uid, dfx.uid:
Count of unique values of the first key and count of values in the second key:
[uid]: 9661
[uid]: 19105
True is values of the first key that exist in the second key:
   values  count
0   False   9467
1    True    194
</pre>
</div>
</div>

<div id="outline-container-org04c1b9c" class="outline-3">
<h3 id="org04c1b9c"><span class="section-number-3">2.4.</span> explore interview.X.csv connection by uid</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Lets explore part of X.csv that have uid in y.csv. and compare with <a href="#org2aed69e">2.1</a>
</p>
<ul class="org-ul">
<li>nypost.com is more frequent than www.dailymotion.com here.</li>
<li>www.dailymotion.com is more frequent in full X.csv.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> explore_sparse_classes

<span style="color: #cae682;">df</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'uid'</span>].isin(dfy[<span style="color: #95e454;">'uid'</span>])]
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df.shape"</span>, df.shape)
<span style="color: #e5786d;">print</span>(df.head(5).to_string())
<span style="color: #e5786d;">print</span>(df.tail(5).to_string())
describe(df)
explore_sparse_classes(df)
</pre>
</div>

<pre class="example" id="org183e7c5">
df.shape (9646, 10)
                reg_time                                   uid  fc_imp_chk  fc_time_chk  utmtr  mm_dma   osName     model      hardware                    site_id
72   2021-07-21 19:29:20  00000000-0000-0001-6268-957597321099           0            7      6     517  Android  SM-N960U  Mobile Phone             dotesports.com
81   2021-07-21 19:29:54  00000000-0000-0001-6268-957946481763           0            7      6     505  Android  Pixel 4a  Mobile Phone         online.seterra.com
83   2021-07-21 19:30:05  00000000-0000-0001-6268-958052831367           0            7      6     501      iOS    iPhone  Mobile Phone               hiphopdx.com
86   2021-07-21 19:30:15  00000000-0000-0001-6268-958153731939           0            7      6     517  Android  SM-G991U  Mobile Phone       www.vivaelbirdos.com
111  2021-07-21 19:32:05  00000000-0000-0001-6268-959263331420           0            7      6     517  Android  SM-N975U  Mobile Phone  www.landgrantholyland.com
                   reg_time                                   uid  fc_imp_chk  fc_time_chk  utmtr  mm_dma   osName     model      hardware             site_id
954731  2021-08-06 15:17:18  00000000-0000-0001-6282-630399791507           3            6      5     617  Android  SM-G991U  Mobile Phone     whatculture.com
954764  2021-08-06 15:18:15  00000000-0000-0001-6282-630943861926           0            7      5     556      iOS    iPhone  Mobile Phone  www.digitalspy.com
955196  2021-08-06 15:27:50  00000000-0000-0001-6282-636710091771           1            6      5       0  Android  SM-G975U  Mobile Phone  www.digitalspy.com
955222  2021-08-06 16:05:52  00000000-0000-0001-6282-626705991151           3            6      5     567      iOS    iPhone  Mobile Phone     whatculture.com
955226  2021-08-06 16:20:32  00000000-0000-0001-6282-668264431034           3            6      5     524      iOS    iPhone  Mobile Phone     whatculture.com
        fc_imp_chk  fc_time_chk        utmtr       mm_dma
count  9646.000000  9646.000000  9646.000000  9646.000000
mean      0.193863     6.910844     3.494505   507.939042
std       0.724844     0.284984     2.357724   152.265613
min       0.000000     6.000000     0.000000     0.000000
25%       0.000000     7.000000     1.000000   505.000000
50%       0.000000     7.000000     4.000000   524.000000
75%       0.000000     7.000000     5.000000   560.000000
max       4.000000     7.000000     7.000000   881.000000
                   reg_time                                   uid osName   model      hardware     site_id
count                  9646                                  9646   9557    9554          9554        9646
unique                 9581                                  9583      6     365             5        1474
top     2021-08-03 13:18:39  00000000-0000-0001-6270-822336041713    iOS  iPhone  Mobile Phone  nypost.com
freq                      2                                     2   5753    5165          9442        1545
reg_time       object
uid            object
fc_imp_chk      int64
fc_time_chk     int64
utmtr           int64
mm_dma          int64
osName         object
model          object
hardware       object
site_id        object
dtype: object
reg_time total features: 9581
percent 1 records: 96 categories: 9581
features lower percent 9581
2021-08-03 13:18:39    0.020734
2021-07-22 10:57:48    0.020734
2021-08-03 20:21:18    0.020734
2021-07-26 00:20:48    0.020734
2021-07-23 15:13:42    0.020734
2021-07-23 14:30:04    0.020734
2021-08-06 03:54:30    0.020734
2021-08-02 11:32:41    0.020734
2021-07-22 15:22:03    0.020734
2021-07-22 12:05:49    0.020734
2021-08-06 06:09:14    0.020734
2021-07-24 10:20:15    0.020734
2021-07-22 15:13:11    0.020734
2021-07-22 12:05:38    0.020734
2021-07-23 19:42:47    0.020734
2021-07-28 02:10:36    0.020734
2021-07-26 21:36:12    0.020734
2021-08-01 19:21:37    0.020734
2021-07-22 08:40:45    0.020734
2021-07-27 13:35:28    0.020734

uid total features: 9583
percent 1 records: 96 categories: 9583
features lower percent 9583
00000000-0000-0001-6270-822336041713    0.020734
00000000-0000-0001-6282-551868761078    0.020734
00000000-0000-0001-6271-002385111706    0.020734
00000000-0000-0001-6278-143043971816    0.020734
00000000-0000-0001-6276-595084281182    0.020734
00000000-0000-0001-6281-252263751170    0.020734
00000000-0000-0001-6280-942294611607    0.020734
00000000-0000-0001-6269-928102541212    0.020734
00000000-0000-0001-6273-775729301680    0.020734
00000000-0000-0001-6274-729142971293    0.020734
00000000-0000-0001-6272-145865621814    0.020734
00000000-0000-0001-6281-301148691126    0.020734
00000000-0000-0001-6276-496120041920    0.020734
00000000-0000-0001-6281-365316241249    0.020734
00000000-0000-0001-6281-266796571270    0.020734
00000000-0000-0001-6276-793304061177    0.020734
00000000-0000-0001-6271-132133851742    0.020734
00000000-0000-0001-6280-285234721668    0.020734
00000000-0000-0001-6280-969859241058    0.020734
00000000-0000-0001-6271-439830551305    0.020734

osName total features: 6
iOS           60.196714
Android       38.715078
Windows 10     0.994036
Windows 7      0.062781
Symbian        0.020927
Linux          0.010464

model total features: 365
percent 1 records: 96 categories: 356
features lower percent 356
iPhone              54.061126
SM-G973U             1.863094
SM-G991U             1.685158
SM-G975U             1.444421
SM-G970U             1.413021
SM-G998U             1.350220
LM-Q730              1.214151
SM-G960U             1.119950
SM-N986U             1.036215
iPhone 11            0.994348
Chrome - Windows     0.994348
SM-N975U             0.921080
SM-G781U             0.910613
SM-G996U             0.847812
LM-K500              0.837346
SM-G986U             0.764078
iPhone XR            0.732677
SM-G965U             0.732677
SM-N960U             0.659410
SM-A215U             0.648943

hardware total features: 5
Mobile Phone    98.827716
Desktop          1.067616
Tablet           0.052334
Media Player     0.041867
Mobile+Phone     0.010467

site_id total features: 1474
percent 1 records: 96 categories: 1461
features lower percent 1460
nypost.com                  16.017002
whatculture.com             14.316815
www.dailymotion.com          6.054323
www.digitalspy.com           3.742484
myfox8.com                   3.390006
www.elle.com                 2.311839
www.yahoo.com                2.270371
my.xfinity.com               1.917893
www.woodtv.com               1.658719
people.com                   1.254406
www.foxbusiness.com          1.212938
whnt.com                     1.067800
www.stltoday.com             1.047066
news.yahoo.com               0.995231
www.wane.com                 0.663487
hu.motorsport.com            0.642753
finance.yahoo.com            0.611652
thespun.com                  0.611652
metropcs.mobileposse.com     0.559818
stocktwits.com               0.507983

</pre>
</div>
</div>

<div id="outline-container-org1442ce6" class="outline-3">
<h3 id="org1442ce6"><span class="section-number-3">2.5.</span> How meny uids repeats?</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> explore_sparse_classes

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">df = pd.read_csv('interview.X.csv')</span>
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)

<span style="color: #cae682;">ut</span> = {}
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"repeats of uids inside tag( without duplicates, all):"</span>)
<span style="color: #e5786d;">print</span>(dfy.drop_duplicates().shape, dfy.shape)
<span style="color: #8ac6f2; font-weight: bold;">for</span> v <span style="color: #8ac6f2; font-weight: bold;">in</span> dfy.tag.unique():
    <span style="color: #cae682;">ut</span>[v] = dfy[dfy[<span style="color: #95e454;">'tag'</span>] == v].uid.tolist()
    <span style="color: #e5786d;">print</span>(v, <span style="color: #e5786d;">len</span>(<span style="color: #e5786d;">set</span>(ut[v])), <span style="color: #e5786d;">len</span>(dfy[dfy[<span style="color: #95e454;">'tag'</span>] == v].uid.tolist()))
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(dfy.uid.tolist())</span>

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">df = df[df['uid'].isin(dfy['uid'])]</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print("df.shape", df.shape)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.head(5).to_string())</span>
</pre>
</div>

<pre class="example" id="orgd673b58">
repeats of uids inside tag( without duplicates, all):
(12477, 2) (15359, 2)
fclick 3780 3942
vregistration 5493 6340
registration 2380 4163
vcontent 455 503
vsignup 229 247
vmisc 42 46
vlead 63 66
signup 17 27
misc 3 4
lead 3 4
content 12 17
</pre>
</div>
</div>

<div id="outline-container-org986e433" class="outline-3">
<h3 id="org986e433"><span class="section-number-3">2.6.</span> count empty or na</h3>
<div class="outline-text-3" id="text-2-6">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfx = dfx.sample(frac=0.05, random_state=42)</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #e5786d;">print</span>(df.isna().<span style="color: #e5786d;">sum</span>())
</pre>
</div>

<pre class="example" id="org2b9fc83">
reg_time            0
uid                 0
fc_imp_chk          0
fc_time_chk         0
utmtr               0
mm_dma              0
osName           7914
model            8418
hardware         8208
site_id             0
tag            945593
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-org66ddfaa" class="outline-3">
<h3 id="org66ddfaa"><span class="section-number-3">2.7.</span> fclick</h3>
<div class="outline-text-3" id="text-2-7">
<p>
We cat see that fclick event is very rare and y target is skewed in
 interview.X.csv
</p>

<p>
We have 3780 fclick events.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> explore_sparse_classes

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)

<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.06, random_state=42)

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 1) fraction of 0.06 of interview.X.csv</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- merge x and y - join dataframes</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(dfy.groupby('tag').tag.size())</span>
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- select rows we require</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- prepare major columns</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist() <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>
<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'fclick'</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
df.replace(<span style="color: #95e454;">'fclick'</span>, 1, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">id filed:</span>
df.reset_index(drop=<span style="color: #e5786d; font-weight: bold;">True</span>, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)

describe(df[[<span style="color: #95e454;">'tag'</span>]])
<span style="color: #e5786d;">print</span>(df[<span style="color: #95e454;">'tag'</span>].value_counts())
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> values_byfreq
values_byfreq(df[<span style="color: #95e454;">'tag'</span>], min_freq=0.3)

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 2) count of all flicks</span>
<span style="color: #cae682;">df</span> = dfy
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- select rows we require</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- prepare major columns</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist() <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>
<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'fclick'</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
df.replace(<span style="color: #95e454;">'fclick'</span>, 1, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">id filed:</span>
df.reset_index(drop=<span style="color: #e5786d; font-weight: bold;">True</span>, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)

describe(df[[<span style="color: #95e454;">'tag'</span>]])
<span style="color: #e5786d;">print</span>(df[<span style="color: #95e454;">'tag'</span>].value_counts())
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> values_byfreq
values_byfreq(df[<span style="color: #95e454;">'tag'</span>], min_freq=0.3)

</pre>
</div>

<pre class="example" id="orga98fe8b">
                tag
count  57497.000000
mean       0.004070
std        0.063665
min        0.000000
25%        0.000000
50%        0.000000
75%        0.000000
max        1.000000
tag
0    57263
1      234
Name: count, dtype: int64
vcp_s tag
0    0.99593
1    0.00407
Name: count, dtype: float64
                tag
count  12477.000000
mean       0.302957
std        0.459555
min        0.000000
25%        0.000000
50%        0.000000
75%        1.000000
max        1.000000
tag
0    8697
1    3780
Name: count, dtype: int64
vcp_s tag
0    0.697043
1    0.302957
Name: count, dtype: float64
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d43a2a" class="outline-2">
<h2 id="org7d43a2a"><span class="section-number-2">3.</span> correlation analysis</h2>
<div class="outline-text-2" id="text-3">
<p>
for all analysis we take 0.05 random records from "interview.X.csv".
</p>
</div>
<div id="outline-container-orgb2c838f" class="outline-3">
<h3 id="orgb2c838f"><span class="section-number-3">3.1.</span> "no tag" vs "with tags" x7</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Lets set tags field for nan as 0 and "with tag" as 1.
We multiply "with tags" by 7 just to see better on plot difference.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">tag = 'fclick'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.isna().sum())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.shape)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">df.dropna(subset=['tag'], inplace=True)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">df = df[df['tag'] != 0]</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">tags2 = tags.copy()</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">tags2.remove(tag)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) replace all tags as 1</span>
df.replace(tags, 1, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.head(15).to_string())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">df = df[df['tag'] != 0]</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df['tag'].unique())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6) increase "with tag"</span>
<span style="color: #cae682;">dfw</span> = df[df[<span style="color: #95e454;">'tag'</span>] == 1]
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x2</span>
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x3</span>
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x4</span>
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x5</span>
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x6</span>
<span style="color: #cae682;">df</span> = pd.concat([df, dfw], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">x7</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">7)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=<span style="color: #95e454;">'./imgs/no_vs_tag.png'</span>, t0=0, t1=1)

</pre>
</div>
</div>
</div>

<div id="outline-container-org4ebf17d" class="outline-3">
<h3 id="org4ebf17d"><span class="section-number-3">3.2.</span> "with tags" vs tag == 'fclick'</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'fclick'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bf690c" class="outline-3">
<h3 id="org4bf690c"><span class="section-number-3">3.3.</span> "with tags" vs tag == 'vregistration'</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'vregistration'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb642359" class="outline-3">
<h3 id="orgb642359"><span class="section-number-3">3.4.</span> "with tags" vs tag == 'registration'</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'registration'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org01b06c2" class="outline-3">
<h3 id="org01b06c2"><span class="section-number-3">3.5.</span> "with tags" vs tag == 'vcontent'</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'vcontent'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org290aad7" class="outline-3">
<h3 id="org290aad7"><span class="section-number-3">3.6.</span> "with tags" vs tag == 'vsignup'</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'vsignup'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc27c978" class="outline-3">
<h3 id="orgc27c978"><span class="section-number-3">3.7.</span> "with tags" vs tag == 'vmisc'</h3>
<div class="outline-text-3" id="text-3-7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'vmisc'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a6ba0c" class="outline-3">
<h3 id="org4a6ba0c"><span class="section-number-3">3.8.</span> "with tags" vs tag == 'vlead'</h3>
<div class="outline-text-3" id="text-3-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'vlead'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org74f6cb9" class="outline-3">
<h3 id="org74f6cb9"><span class="section-number-3">3.9.</span> "with tags" vs tag == 'signup'</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'signup'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgafbec5b" class="outline-3">
<h3 id="orgafbec5b"><span class="section-number-3">3.10.</span> "with tags" vs tag == 'misc'</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'misc'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7669009" class="outline-3">
<h3 id="org7669009"><span class="section-number-3">3.11.</span> "with tags" vs tag == 'lead'</h3>
<div class="outline-text-3" id="text-3-11">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'lead'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfb79505" class="outline-3">
<h3 id="orgfb79505"><span class="section-number-3">3.12.</span> "with tags" vs tag == 'content'</h3>
<div class="outline-text-3" id="text-3-12">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> frequency_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">dfx</span> = dfx.sample(frac=0.05, random_state=42)
<span style="color: #cae682;">tags</span> = dfy.tag.unique().tolist()
<span style="color: #e5786d;">print</span>(tags) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">['fclick', 'vregistration', 'registration', 'vcontent', 'vsignup', 'vmisc', 'vlead', 'signup', 'misc', 'lead', 'content']</span>

<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'content'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1) merge x and y</span>
<span style="color: #cae682;">df</span> = pd.merge(dfx, dfy, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"left"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2) tag nan =&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">3) filter tag != 0 - to filter dfy with tags only</span>
<span style="color: #cae682;">df</span> = df[df[<span style="color: #95e454;">'tag'</span>] != 0]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">4) tag != tag =&gt; 0 - to see only one tag and others at background</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(tags2)</span>

df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">5) drop timeline and uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>, <span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">6)</span>
frequency_analysis(df, target=<span style="color: #95e454;">'tag'</span>, image_save=f<span style="color: #95e454;">'./imgs/no_vs_</span>{tag}<span style="color: #95e454;">.png'</span>, t0=0, t1=tag)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org80c1ed4" class="outline-2">
<h2 id="org80c1ed4"><span class="section-number-2">4.</span> prediction</h2>
<div class="outline-text-2" id="text-4">
<p>
We will solve task "Probability of fclick" by binary classification
 with output calibration.
</p>

<p>
steps:
</p>
<ol class="org-ol">
<li>prepare data</li>
<li>select metric</li>
<li>select model</li>
<li>model finetuning</li>
</ol>
</div>

<div id="outline-container-orge27e97a" class="outline-3">
<h3 id="orge27e97a"><span class="section-number-3">4.1.</span> prepare data</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The plan:
</p>
<ol class="org-ol">
<li>Compose result data from merge vertically:
<ol class="org-ol">
<li>all y uids records.</li>
<li>0.06 percent of other data.</li>
</ol></li>
<li>pre_process: select rows we require, prepare major columns, join dataframes</li>
<li>process_by_handes: check unbalanced and empty columns, remove
columns, correct types, unite columns, feature engineering,</li>
<li>split to train and test</li>
<li>train: remove outlieners in numerical columns</li>
<li>fill nan values - train and test</li>
<li>encode categorical and fix sparse classes
<ol class="org-ol">
<li>select frequence to fix sparse classes</li>
</ol></li>
</ol>

<p>
Degree of imbalance: 3044/52296=0.06 - "Extreme" imbalance.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> outliers_numerical
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> fill_na
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> sparse_classes
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> split
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> encode_categorical_pipe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> values_byfreq

<span style="color: #cae682;">dfx</span> = pd.read_csv(<span style="color: #95e454;">'interview.X.csv'</span>)
<span style="color: #cae682;">dfy</span> = pd.read_csv(<span style="color: #95e454;">'interview.y.csv'</span>)

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 1. Compose result data from merge vertically</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- y: drop duplicates</span>
dfy.drop_duplicates([<span style="color: #95e454;">"uid"</span>, <span style="color: #95e454;">"tag"</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"dfy['tag'].value_counts():"</span>)
<span style="color: #e5786d;">print</span>(dfy[<span style="color: #95e454;">'tag'</span>].value_counts())
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- first part of join 1): merge y and x - join dataframes horizontally</span>
<span style="color: #cae682;">df1</span> = pd.merge(dfy, dfx, on=<span style="color: #95e454;">"uid"</span>, how=<span style="color: #95e454;">"inner"</span>)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df1"</span>, df1.columns)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df1['tag'].value_counts()"</span>)
<span style="color: #e5786d;">print</span>(df1[<span style="color: #95e454;">'tag'</span>].value_counts())
describe(df1, <span style="color: #95e454;">"df1"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- mark records in X that not exist in first part (1))</span>
<span style="color: #cae682;">df_all</span> = dfx.merge(df1.drop_duplicates(), on=[<span style="color: #95e454;">'uid'</span>],
                   how=<span style="color: #95e454;">'left'</span>, indicator=<span style="color: #e5786d; font-weight: bold;">True</span>,
                   suffixes=[<span style="color: #e5786d; font-weight: bold;">None</span>, <span style="color: #95e454;">'_ycolumn'</span>])
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df_all.columns:"</span>, df_all.columns)
<span style="color: #e5786d;">print</span>()
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- select not exist records</span>
<span style="color: #cae682;">df_all_not</span> = df_all[df_all[<span style="color: #95e454;">'_merge'</span>] == <span style="color: #95e454;">'left_only'</span>]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- drop "merge" columns</span>
<span style="color: #cae682;">df_all_not</span> = df_all_not[[c <span style="color: #8ac6f2; font-weight: bold;">for</span> c <span style="color: #8ac6f2; font-weight: bold;">in</span> df_all_not.columns <span style="color: #8ac6f2; font-weight: bold;">if</span> <span style="color: #8ac6f2; font-weight: bold;">not</span> c.endswith(<span style="color: #95e454;">'_ycolumn'</span>)]]
df_all_not.drop(columns=[<span style="color: #95e454;">'_merge'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- get 0.06 part, this is 2)</span>
<span style="color: #cae682;">df_all_not</span> = df_all_not.sample(frac=0.06, random_state=42)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df_all_not"</span>, df_all_not.describe())
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"df_all_not"</span>, df_all_not.columns)
describe(df_all_not, <span style="color: #95e454;">"df_all_not"</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- merge vertically (1)) and (2))</span>
<span style="color: #cae682;">df</span> = pd.concat([df1, df_all_not], axis=0, ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>)
describe(df, <span style="color: #95e454;">"df"</span>)

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;"># ------- 2. pre_process</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- major column: nan -&gt; 0</span>
df[<span style="color: #95e454;">'tag'</span>].fillna(0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- drop uid</span>
df.drop(columns=[<span style="color: #95e454;">'uid'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- tag: fclick, other -&gt; 0</span>
<span style="color: #cae682;">tags</span> = df.tag.unique().tolist()
<span style="color: #cae682;">tag</span> = <span style="color: #95e454;">'fclick'</span>
<span style="color: #cae682;">tags2</span> = tags.copy()
tags2.remove(tag)
df.replace(tags2, 0, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- tag: fclick -&gt; 1</span>
df.replace(<span style="color: #95e454;">'fclick'</span>, 1, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- reset pandas index</span>
df.reset_index(drop=<span style="color: #e5786d; font-weight: bold;">True</span>, inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
describe(df, <span style="color: #95e454;">"df_final"</span>)
<span style="color: #e5786d;">print</span>(df.dtypes)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 3. process_by_handes: check unbalanced and empty columns, remove</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- columns, correct types, unite columns, feature engineering,</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- correct types</span>
<span style="color: #cae682;">df</span>[<span style="color: #95e454;">'reg_time'</span>] = pd.to_datetime(df[<span style="color: #95e454;">'reg_time'</span>])
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- feature engineering</span>
<span style="color: #cae682;">df</span>[<span style="color: #95e454;">'dayofweek'</span>] = df.reg_time.dt.dayofweek
<span style="color: #cae682;">df</span>[<span style="color: #95e454;">'hour'</span>] = df.reg_time.dt.hour
<span style="color: #cae682;">df</span>[<span style="color: #95e454;">'month'</span>] = df.reg_time.dt.month
<span style="color: #cae682;">df</span>[<span style="color: #95e454;">'quarter'</span>] = df.reg_time.dt.quarter
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- remove columns</span>
df.drop(columns=[<span style="color: #95e454;">'reg_time'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- correct types</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df.dtypes)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 4. split to train and test and save indexes</span>
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'split_train.pickle'</span>
<span style="color: #cae682;">p2</span> = <span style="color: #95e454;">'split_test.pickle'</span>
split(df, p1, p2, target_col=<span style="color: #95e454;">'tag'</span>)  <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">and select columns, remove special cases, save id</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 5. train: remove outlieners in numerical columns</span>
<span style="color: #cae682;">p1</span> = outliers_numerical(p1, 0.0006, target=<span style="color: #95e454;">'tag'</span>,
                            ignore_columns=[])  <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">require fill_na for skew test</span>

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 6. fill NaN values with mode</span>
<span style="color: #cae682;">p1</span> = fill_na(p1, <span style="color: #95e454;">'fill_na_p1.pickle'</span>, id_check1=<span style="color: #95e454;">'id_train.pickle'</span>)
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'fill_na_p1.pickle'</span>
<span style="color: #cae682;">p2</span> = fill_na(p2, <span style="color: #95e454;">'fill_na_p2.pickle'</span>, id_check1=<span style="color: #95e454;">'id_test.pickle'</span>)
<span style="color: #cae682;">p2</span> = <span style="color: #95e454;">'fill_na_p2.pickle'</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">------- 7. encode categorical</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- select frequence to fix sparse classes</span>
<span style="color: #cae682;">df</span> = load(p1)

<span style="color: #8ac6f2; font-weight: bold;">for</span> c <span style="color: #8ac6f2; font-weight: bold;">in</span> df.columns:
    <span style="color: #cae682;">l</span>, <span style="color: #cae682;">h</span> = values_byfreq(df[c], min_freq=0.005)
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(l, h)</span>
    <span style="color: #e5786d;">print</span>(<span style="color: #e5786d;">len</span>(l), <span style="color: #e5786d;">len</span>(h))
    <span style="color: #e5786d;">print</span>()

<span style="color: #cae682;">p1</span>, <span style="color: #cae682;">encoders</span> = encode_categorical_pipe(p1, id_check=<span style="color: #95e454;">'id_train.pickle'</span>,
                                       p_save=<span style="color: #95e454;">'train.pickle'</span>,
                                       min_frequency=0.005)  <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1 or 0 # fill_na required</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(p1, encoders)</span>
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train.pickle'</span>
<span style="color: #cae682;">p2</span>, <span style="color: #cae682;">encoders</span> = encode_categorical_pipe(p2, id_check=<span style="color: #95e454;">'id_test.pickle'</span>,
                                             encoders_train=encoders,
                                             p_save=<span style="color: #95e454;">'test.pickle'</span>)  <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">1 or 0 # fill_na required</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;"># print("p2", p2)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">p2 = 'test.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #e5786d;">print</span>(df[<span style="color: #95e454;">'tag'</span>].value_counts())
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">describe(df, 'p2')</span>
</pre>
</div>

<pre class="example" id="org4224a02">
dfy['tag'].value_counts():
tag
vregistration    5493
fclick           3780
registration     2380
vcontent          455
vsignup           229
vlead              63
vmisc              42
signup             17
content            12
misc                3
lead                3
Name: count, dtype: int64
df1 Index(['uid', 'tag', 'reg_time', 'fc_imp_chk', 'fc_time_chk', 'utmtr',
       'mm_dma', 'osName', 'model', 'hardware', 'site_id'],
      dtype='object')
df1['tag'].value_counts()
tag
vregistration    5462
fclick           3808
registration     2394
vcontent          451
vsignup           225
vlead              63
vmisc              42
signup             17
content            11
lead                5
misc                4
Name: count, dtype: int64
describe df1:
         fc_imp_chk   fc_time_chk         utmtr        mm_dma
count  12482.000000  12482.000000  12482.000000  12482.000000
mean       0.214228      6.902660      3.497917    509.229130
std        0.763163      0.296432      2.367631    151.761701
min        0.000000      6.000000      0.000000      0.000000
25%        0.000000      7.000000      1.000000    505.000000
50%        0.000000      7.000000      4.000000    524.000000
75%        0.000000      7.000000      5.000000    561.000000
max        4.000000      7.000000      7.000000    881.000000
                                         uid            tag             reg_time osName   model      hardware     site_id
count                                  12482          12482                12482  12371   12367         12367       12482
unique                                  9583             11                 9581      6     365             5        1474
top     00000000-0000-0001-6274-085318351101  vregistration  2021-08-01 02:53:18    iOS  iPhone  Mobile Phone  nypost.com
freq                                      10           5462                    5   7306    6517         12202        2259
df1.isna().sum():
uid              0
tag              0
reg_time         0
fc_imp_chk       0
fc_time_chk      0
utmtr            0
mm_dma           0
osName         111
model          115
hardware       115
site_id          0
dtype: int64
Values counts:
fc_imp_chk int64
fc_imp_chk
0    11267
1      559
4      322
2      175
3      159
Name: count, dtype: int64
fc_time_chk int64
fc_time_chk
7    11267
6     1215
Name: count, dtype: int64
osName object
osName
iOS           7306
Android       4906
Windows 10     138
Windows 7       15
Symbian          4
Linux            2
Name: count, dtype: int64
hardware object
hardware
Mobile Phone    12202
Desktop           155
Tablet              5
Media Player        4
Mobile+Phone        1
Name: count, dtype: int64

df_all.columns: Index(['reg_time', 'uid', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma',
       'osName', 'model', 'hardware', 'site_id', 'tag', 'reg_time_ycolumn',
       'fc_imp_chk_ycolumn', 'fc_time_chk_ycolumn', 'utmtr_ycolumn',
       'mm_dma_ycolumn', 'osName_ycolumn', 'model_ycolumn', 'hardware_ycolumn',
       'site_id_ycolumn', '_merge'],
      dtype='object')

df_all_not          fc_imp_chk   fc_time_chk         utmtr        mm_dma
count  56736.000000  56736.000000  56736.000000  56736.000000
mean       0.190884      6.912771      3.255129    523.959602
std        0.729186      0.287371      2.371447    129.450072
min       -1.000000     -1.000000      0.000000      0.000000
25%        0.000000      7.000000      1.000000    505.000000
50%        0.000000      7.000000      3.000000    524.000000
75%        0.000000      7.000000      5.000000    567.000000
max        4.000000      7.000000      7.000000    881.000000
df_all_not Index(['reg_time', 'uid', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma',
       'osName', 'model', 'hardware', 'site_id', 'tag'],
      dtype='object')
describe df_all_not:
         fc_imp_chk   fc_time_chk         utmtr        mm_dma
count  56736.000000  56736.000000  56736.000000  56736.000000
mean       0.190884      6.912771      3.255129    523.959602
std        0.729186      0.287371      2.371447    129.450072
min       -1.000000     -1.000000      0.000000      0.000000
25%        0.000000      7.000000      1.000000    505.000000
50%        0.000000      7.000000      3.000000    524.000000
75%        0.000000      7.000000      5.000000    567.000000
max        4.000000      7.000000      7.000000    881.000000
                   reg_time                                   uid osName   model      hardware              site_id  tag
count                 56736                                 56736  56268   56241         56251                56736    0
unique                55246                                 56736      5     728             4                 4137    0
top     2021-07-24 00:14:03  00000000-0000-0001-6272-478103421800    iOS  iPhone  Mobile Phone  www.dailymotion.com  NaN
freq                      4                                     1  42167   36854         56224                 8862  NaN
df_all_not.isna().sum():
reg_time           0
uid                0
fc_imp_chk         0
fc_time_chk        0
utmtr              0
mm_dma             0
osName           468
model            495
hardware         485
site_id            0
tag            56736
dtype: int64
Values counts:
fc_imp_chk int64
fc_imp_chk
 0    51808
 1     2396
 4     1412
 2      562
 3      555
-1        3
Name: count, dtype: int64
fc_time_chk int64
fc_time_chk
 7    51808
 6     4925
-1        3
Name: count, dtype: int64
osName object
osName
iOS           42167
Android       14096
Windows 10        2
Symbian           2
OS X              1
Name: count, dtype: int64
hardware object
hardware
Mobile Phone    56224
Media Player       23
Desktop             3
Mobile+Phone        1
Name: count, dtype: int64
tag object
Series([], Name: count, dtype: int64)

describe df:
         fc_imp_chk   fc_time_chk         utmtr        mm_dma
count  69218.000000  69218.000000  69218.000000  69218.000000
mean       0.195094      6.910948      3.298911    521.303274
std        0.735478      0.289050      2.372579    133.867523
min       -1.000000     -1.000000      0.000000      0.000000
25%        0.000000      7.000000      1.000000    505.000000
50%        0.000000      7.000000      4.000000    524.000000
75%        0.000000      7.000000      5.000000    566.000000
max        4.000000      7.000000      7.000000    881.000000
                                         uid            tag             reg_time osName   model      hardware              site_id
count                                  69218          12482                69218  68639   68608         68618                69218
unique                                 66319             11                64348      7     757             5                 4445
top     00000000-0000-0001-6274-085318351101  vregistration  2021-08-01 02:53:18    iOS  iPhone  Mobile Phone  www.dailymotion.com
freq                                      10           5462                    5  49473   43371         68426                 9517
df.isna().sum():
uid                0
tag            56736
reg_time           0
fc_imp_chk         0
fc_time_chk        0
utmtr              0
mm_dma             0
osName           579
model            610
hardware         600
site_id            0
dtype: int64
Values counts:
fc_imp_chk int64
fc_imp_chk
 0    63075
 1     2955
 4     1734
 2      737
 3      714
-1        3
Name: count, dtype: int64
fc_time_chk int64
fc_time_chk
 7    63075
 6     6140
-1        3
Name: count, dtype: int64
hardware object
hardware
Mobile Phone    68426
Desktop           158
Media Player       27
Tablet              5
Mobile+Phone        2
Name: count, dtype: int64

describe df_final:
                tag    fc_imp_chk   fc_time_chk         utmtr        mm_dma
count  69218.000000  69218.000000  69218.000000  69218.000000  69218.000000
mean       0.055015      0.195094      6.910948      3.298911    521.303274
std        0.228010      0.735478      0.289050      2.372579    133.867523
min        0.000000     -1.000000     -1.000000      0.000000      0.000000
25%        0.000000      0.000000      7.000000      1.000000    505.000000
50%        0.000000      0.000000      7.000000      4.000000    524.000000
75%        0.000000      0.000000      7.000000      5.000000    566.000000
max        1.000000      4.000000      7.000000      7.000000    881.000000
                   reg_time osName   model      hardware              site_id
count                 69218  68639   68608         68618                69218
unique                64348      7     757             5                 4445
top     2021-08-01 02:53:18    iOS  iPhone  Mobile Phone  www.dailymotion.com
freq                      5  49473   43371         68426                 9517
df_final.isna().sum():
tag              0
reg_time         0
fc_imp_chk       0
fc_time_chk      0
utmtr            0
mm_dma           0
osName         579
model          610
hardware       600
site_id          0
dtype: int64
Values counts:
tag int64
tag
0    65410
1     3808
Name: count, dtype: int64
fc_imp_chk int64
fc_imp_chk
 0    63075
 1     2955
 4     1734
 2      737
 3      714
-1        3
Name: count, dtype: int64
fc_time_chk int64
fc_time_chk
 7    63075
 6     6140
-1        3
Name: count, dtype: int64
hardware object
hardware
Mobile Phone    68426
Desktop           158
Media Player       27
Tablet              5
Mobile+Phone        2
Name: count, dtype: int64

tag             int64
reg_time       object
fc_imp_chk      int64
fc_time_chk     int64
utmtr           int64
mm_dma          int64
osName         object
model          object
hardware       object
site_id        object
dtype: object
WARNING:root:id.pickle was not found.

-- ok -- id_train.pickle

-- ok -- id_test.pickle

-- ok -- split_train.pickle (55374, 13) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'osName', 'model', 'hardware', 'site_id', 'dayofweek', 'hour', 'month', 'quarter']

-- ok -- split_test.pickle (13844, 13) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'osName', 'model', 'hardware', 'site_id', 'dayofweek', 'hour', 'month', 'quarter']
per target 0: 32 , per target 1: 2
                1
0
mm_dma_0       30
fc_imp_chk_0    2
tag_0           0
fc_time_chk_0   0
utmtr_0         0
dayofweek_0     0
hour_0          0
month_0         0
quarter_0       0
               1
0
mm_dma_1       2
tag_1          0
fc_imp_chk_1   0
fc_time_chk_1  0
utmtr_1        0
dayofweek_1    0
hour_1         0
month_1        0
quarter_1      0


-- ok -- id_train.pickle
filtered:              1
0
mm_dma      32
fc_imp_chk   2
total filtered count: 34

-- ok -- without_outliers.pickle (55340, 13) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'osName', 'model', 'hardware', 'site_id', 'dayofweek', 'hour', 'month', 'quarter']
2 unique values columns excluded: set()
NA count in categorical columns:
osName 460
model 482
site_id 0
hardware 475

fill na with mode in categorical:
 osName                      iOS
model                    iPhone
site_id     www.dailymotion.com
hardware           Mobile Phone
Name: 0, dtype: object

ids check: 55340 55340

-- ok -- fill_na_p1.pickle (55340, 13) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'osName', 'model', 'hardware', 'site_id', 'dayofweek', 'hour', 'month', 'quarter']
2 unique values columns excluded: set()
NA count in categorical columns:
osName 117
model 126
site_id 0
hardware 123

fill na with mode in categorical:
 osName                      iOS
model                    iPhone
site_id     www.dailymotion.com
hardware           Mobile Phone
Name: 0, dtype: object

ids check: 13844 13844

-- ok -- fill_na_p2.pickle (13844, 13) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'osName', 'model', 'hardware', 'site_id', 'dayofweek', 'hour', 'month', 'quarter']
vcp_s tag
0    0.944995
1    0.055005
Name: count, dtype: float64
2 0

vcp_s fc_imp_chk
0    0.911420
1    0.042826
4    0.024810
2    0.010896
3    0.010047
Name: count, dtype: float64
5 0

vcp_s fc_time_chk
7    0.91142
6    0.08858
Name: count, dtype: float64
2 0

vcp_s utmtr
0    0.196205
4    0.142158
5    0.131641
6    0.126382
3    0.120853
1    0.118594
7    0.101409
2    0.062757
Name: count, dtype: float64
8 0

vcp_s mm_dma
501    0.154951
524    0.102963
517    0.060752
0      0.051771
505    0.046476
         ...
500    0.000018
531    0.000018
613    0.000018
526    0.000018
543    0.000018
Name: count, Length: 130, dtype: float64
44 86

vcp_s osName
iOS           0.723310
Android       0.274250
Windows 10    0.002132
Windows 7     0.000235
Symbian       0.000054
OS X          0.000018
Name: count, dtype: float64
2 4

vcp_s model
iPhone       0.634731
iPhone 11    0.015125
iPhone XR    0.011764
SM-G973U     0.009776
SM-G991U     0.009396
               ...
CPH2021      0.000018
COL-L29      0.000018
SM-A105G     0.000018
3.1 Plus     0.000018
VOG-L09      0.000018
Name: count, Length: 708, dtype: float64
18 690

vcp_s hardware
Mobile Phone    0.997091
Desktop         0.002385
Media Player    0.000416
Tablet          0.000072
Mobile+Phone    0.000036
Name: count, dtype: float64
1 4

vcp_s site_id
www.dailymotion.com               0.137532
whatculture.com                   0.117691
nypost.com                        0.097470
www.digitalspy.com                0.032056
myfox8.com                        0.019913
                                    ...
pmnewsnigeria.com                 0.000018
www.ytravelblog.com               0.000018
www.papernstitchblog.com          0.000018
www.prayerandpossibilities.com    0.000018
7news.com.au                      0.000018
Name: count, Length: 3984, dtype: float64
24 3960

vcp_s dayofweek
4    0.194977
3    0.194236
6    0.130484
5    0.127539
2    0.122786
0    0.122768
1    0.107210
Name: count, dtype: float64
7 0

vcp_s hour
1     0.071612
2     0.067239
0     0.057336
3     0.055548
14    0.049964
13    0.046675
12    0.045537
11    0.045392
21    0.045356
15    0.044471
16    0.044254
20    0.043892
17    0.042862
19    0.042826
10    0.041507
18    0.039646
4     0.035905
22    0.034658
9     0.033863
5     0.027214
6     0.021919
8     0.021630
23    0.021540
7     0.019154
Name: count, dtype: float64
24 0

vcp_s month
7    0.634478
8    0.365522
Name: count, dtype: float64
2 0

vcp_s quarter
3    1.0
Name: count, dtype: float64
1 0

vcp_s osName
iOS           0.723310
Android       0.274250
Windows 10    0.002132
Windows 7     0.000235
Symbian       0.000054
OS X          0.000018
Name: count, dtype: float64
vcp_s model
iPhone       0.634731
iPhone 11    0.015125
iPhone XR    0.011764
SM-G973U     0.009776
SM-G991U     0.009396
               ...
CPH2021      0.000018
COL-L29      0.000018
SM-A105G     0.000018
3.1 Plus     0.000018
VOG-L09      0.000018
Name: count, Length: 708, dtype: float64
vcp_s hardware
Mobile Phone    0.997091
Desktop         0.002385
Media Player    0.000416
Tablet          0.000072
Mobile+Phone    0.000036
Name: count, dtype: float64
vcp_s site_id
www.dailymotion.com               0.137532
whatculture.com                   0.117691
nypost.com                        0.097470
www.digitalspy.com                0.032056
myfox8.com                        0.019913
                                    ...
pmnewsnigeria.com                 0.000018
www.ytravelblog.com               0.000018
www.papernstitchblog.com          0.000018
www.prayerandpossibilities.com    0.000018
7news.com.au                      0.000018
Name: count, Length: 3984, dtype: float64
label columns ['osName', 'hardware']
onehot columns ['model', 'site_id']
numerical columns ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'dayofweek', 'hour', 'month', 'quarter']

LabelEncoder:
infrequent_categories {'osName': array(['OS X', 'Symbian', 'Windows 10', 'Windows 7'], dtype=object), 'hardware': array(['Desktop', 'Media Player', 'Mobile+Phone', 'Tablet'], dtype=object)}

['osName', 'hardware'] OrdinalEncoder(min_frequency=0.005)
   tag  fc_imp_chk  fc_time_chk  utmtr  mm_dma     model                site_id  dayofweek  hour  month  quarter  osName  hardware
0    0           0            7      0     630    iPhone    www.dailymotion.com          3     0      7        3     1.0       0.0
1    0           0            7      0     501    iPhone  www.lemonsforlulu.com          4     2      7        3     1.0       0.0
2    0           0            7      5     609  SM-G988U             nypost.com          4    16      7        3     0.0       0.0
One-Hot result columns:
['osName', 'hardware']
after l encoder: ['osName', 'hardware'] ['osName', 'hardware']

encode_categorical_onehot:
infrequent categories for: model 1

infrequent categories for: site_id 1

One-Hot result columns:
model ['model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other']
site_id ['site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']
onehot_encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False)}
Two values with NA columns:

label ['osName', 'hardware']
onehot ['model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other', 'site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']

before encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False)} {'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
final encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
ids check: 55340 55340

-- ok -- train.pickle (55340, 55) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'dayofweek', 'hour', 'month', 'quarter', 'osName', 'hardware', 'model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other', 'site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']
label columns ['osName', 'hardware']
onehot columns ['model', 'site_id']
numerical columns ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'dayofweek', 'hour', 'month', 'quarter']

LabelEncoder:
columns ['osName', 'hardware']
encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
infrequent_categories {'osName': array(['OS X', 'Symbian', 'Windows 10', 'Windows 7'], dtype=object), 'hardware': array(['Desktop', 'Media Player', 'Mobile+Phone', 'Tablet'], dtype=object)}

['osName', 'hardware'] OrdinalEncoder(min_frequency=0.005)
   tag  fc_imp_chk  fc_time_chk  utmtr  mm_dma   model               site_id  dayofweek  hour  month  quarter  osName  hardware
0    0           0            7      0     563  iPhone  www.bluemoongame.com          5     2      7        3     1.0       0.0
1    0           0            7      4     501  iPhone        stocktwits.com          2    14      7        3     1.0       0.0
2    0           0            7      6     556  iPhone   www.dailymotion.com          4    18      7        3     1.0       0.0
One-Hot result columns:
['osName', 'hardware']
after l encoder: ['osName', 'hardware'] ['osName', 'hardware']

encode_categorical_onehot:
One-Hot result columns:
model ['model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other']
site_id ['site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']
onehot_encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
Two values with NA columns:

label ['osName', 'hardware']
onehot ['model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other', 'site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']

before encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)} {'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
final encoders {'model': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'site_id': OneHotEncoder(handle_unknown='infrequent_if_exist', min_frequency=0.005,
              sparse_output=False), 'osName': OrdinalEncoder(min_frequency=0.005), 'hardware': OrdinalEncoder(min_frequency=0.005)}
ids check: 13844 13844

-- ok -- test.pickle (13844, 55) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'dayofweek', 'hour', 'month', 'quarter', 'osName', 'hardware', 'model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other', 'site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']
tag
0.0    52296
1.0     3044
Name: count, dtype: int64
</pre>
</div>
</div>

<div id="outline-container-orgaac5e76" class="outline-3">
<h3 id="orgaac5e76"><span class="section-number-3">4.2.</span> zero classifier</h3>
<div class="outline-text-3" id="text-4-2">
<p>
We have highly skewed class distributions.
It is unbalanced classification.
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.dummy <span style="color: #8ac6f2; font-weight: bold;">import</span> DummyClassifier

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfx = pd.read_csv('interview.X.csv')</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfy = pd.read_csv('interview.y.csv')</span>
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #e5786d;">print</span>(df.shape)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfx = dfx.sample(frac=0.05, random_state=42)</span>
<span style="color: #e5786d;">print</span>(df.head(5).to_string())
<span style="color: #cae682;">y</span> = df[<span style="color: #95e454;">'tag'</span>]
<span style="color: #cae682;">X</span> = df.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(X.columns.tolist())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(y)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">----------- select metrics 1) dummy ----</span>

<span style="color: #cae682;">dummy_clf</span> = DummyClassifier()
dummy_clf.fit(X, y)
dummy_clf.predict(X)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"predict"</span>, dummy_clf.predict(X))
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"score"</span>, dummy_clf.score(X, y))
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'---'</span>)
<span style="color: #cae682;">v</span> = dummy_clf.predict(X)
<span style="color: #e5786d;">print</span>(<span style="color: #e5786d;">sum</span>(v))
</pre>
</div>

<pre class="example" id="org7d8314f">
(55340, 55)
   tag  fc_imp_chk  fc_time_chk  utmtr  mm_dma  dayofweek  hour  month  quarter  osName  hardware  model_SM-G960U  model_SM-G965U  model_SM-G970U  model_SM-G973U  model_SM-G975U  model_SM-G986U  model_SM-G991U  model_SM-G998U  model_SM-N975U  model_SM-N986U  model_iPhone  model_iPhone 11  model_iPhone 11 Pro Max  model_iPhone 12  model_iPhone 12 Pro  model_iPhone 12 Pro Max  model_iPhone 8 Plus  model_iPhone XR  model_other  site_id_currently.att.yahoo.com  site_id_finance.yahoo.com  site_id_heavy.com  site_id_hu.motorsport.com  site_id_metropcs.mobileposse.com  site_id_my.xfinity.com  site_id_myfox8.com  site_id_news.yahoo.com  site_id_nypost.com  site_id_people.com  site_id_stocktwits.com  site_id_tbc.wowhead.com  site_id_thespun.com  site_id_whatculture.com  site_id_whnt.com  site_id_www.dailymotion.com  site_id_www.digitalspy.com  site_id_www.elle.com  site_id_www.foxbusiness.com  site_id_www.stltoday.com  site_id_www.wane.com  site_id_www.woodtv.com  site_id_www.wowhead.com  site_id_www.yahoo.com  site_id_other
0  0.0         0.0          7.0    0.0   630.0        3.0   0.0    7.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          1.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
1  0.0         0.0          7.0    0.0   501.0        4.0   2.0    7.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            1.0
2  0.0         0.0          7.0    5.0   609.0        4.0  16.0    7.0      3.0     0.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           0.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          1.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 1.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
3  0.0         0.0          7.0    0.0   551.0        0.0   1.0    8.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          1.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
4  0.0         0.0          7.0    5.0   510.0        6.0  17.0    8.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           0.0              1.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   1.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
predict [0. 0. 0. ... 0. 0. 0.]
score 0.9449945789663896
---
0.0
</pre>
</div>
</div>

<div id="outline-container-org69078e0" class="outline-3">
<h3 id="org69078e0"><span class="section-number-3">4.3.</span> oversampling with SMOTE</h3>
<div class="outline-text-3" id="text-4-3">
<p>
SMOTE: Synthetic Minority Over-sampling Technique <a href="https://arxiv.org/abs/1106.1813">https://arxiv.org/abs/1106.1813</a>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> numpy <span style="color: #8ac6f2; font-weight: bold;">as</span> np
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">from random import randrange, choice</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.neighbors <span style="color: #8ac6f2; font-weight: bold;">import</span> NearestNeighbors
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.manifold <span style="color: #8ac6f2; font-weight: bold;">import</span> MDS <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">slow</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.preprocessing <span style="color: #8ac6f2; font-weight: bold;">import</span> StandardScaler <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">fast</span>

<span style="color: #cae682;">TOLERANCE</span> = 5
<span style="color: #cae682;">p</span> = <span style="color: #e5786d;">float</span>(10**TOLERANCE)
<span style="color: #8ac6f2; font-weight: bold;">def</span> <span style="color: #cae682; font-weight: bold;">my_round_5</span>(some_float):
    <span style="color: #8ac6f2; font-weight: bold;">return</span> <span style="color: #e5786d;">int</span>(some_float * p + 0.5)/p

<span style="color: #8ac6f2; font-weight: bold;">def</span> <span style="color: #cae682; font-weight: bold;">SMOTE</span>(T, N:<span style="color: #e5786d;">int</span>, k:<span style="color: #e5786d;">int</span>):
    <span style="color: #f08080; font-style: italic;">"""</span>
<span style="color: #f08080; font-style: italic;">    Returns (N/100) * n_minority_samples synthetic minority samples.</span>

<span style="color: #f08080; font-style: italic;">    Parameters</span>
<span style="color: #f08080; font-style: italic;">    ----------</span>
<span style="color: #f08080; font-style: italic;">    T : array-like, shape = [n_minority_samples, n_features]</span>
<span style="color: #f08080; font-style: italic;">        Holds the minority samples</span>
<span style="color: #f08080; font-style: italic;">    N : percetange of new synthetic samples:</span>
<span style="color: #f08080; font-style: italic;">        n_synthetic_samples = N/100 * n_minority_samples. Can be &lt; 100.</span>
<span style="color: #f08080; font-style: italic;">    k : int. Number of nearest neighbours.</span>

<span style="color: #f08080; font-style: italic;">    Returns</span>
<span style="color: #f08080; font-style: italic;">    -------</span>
<span style="color: #f08080; font-style: italic;">    S : array, shape = [(N/100) * n_minority_samples, n_features]</span>
<span style="color: #f08080; font-style: italic;">    """</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- no scaling</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">TFIXED = T</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;"># - create scaled or dirensionaly reducted dataset, to fight mixed data types</span>
    <span style="color: #cae682;">TFIXED</span> = StandardScaler(copy=<span style="color: #e5786d; font-weight: bold;">False</span>, with_mean=<span style="color: #e5786d; font-weight: bold;">False</span>).fit_transform(T)
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;"># - slow alternative</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">embedding = MDS(n_components=2, metric=False, normalized_stress='auto')</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">TFIXED = embedding.fit_transform(T)</span>

    <span style="color: #cae682;">n_minority_samples</span>, <span style="color: #cae682;">n_features</span> = T.shape <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">rows, columns</span>

    <span style="color: #8ac6f2; font-weight: bold;">if</span> N &lt; 100:
        <span style="color: #fa8072;">#</span><span style="color: #99968b; font-style: italic;">create synthetic samples only for a subset of T.</span>
        <span style="color: #fa8072;">#</span><span style="color: #99968b; font-style: italic;">TODO: select random minortiy samples</span>
        <span style="color: #cae682;">N</span> = 100
        <span style="color: #8ac6f2; font-weight: bold;">pass</span>

    <span style="color: #8ac6f2; font-weight: bold;">if</span> (N % 100) != 0:
        <span style="color: #8ac6f2; font-weight: bold;">raise</span> <span style="color: #92a65e; font-weight: bold;">ValueError</span>(<span style="color: #95e454;">"N must be &lt; 100 or multiple of 100"</span>)

    <span style="color: #cae682;">NN</span> = N//100
    <span style="color: #e5786d;">print</span>(N/100, n_minority_samples)
    <span style="color: #cae682;">n_synthetic_samples</span> = <span style="color: #e5786d;">round</span>(NN * n_minority_samples) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">20%</span>
    <span style="color: #e5786d;">print</span>(n_synthetic_samples, n_features)
    <span style="color: #cae682;">S</span> = np.zeros(shape=(n_synthetic_samples, n_features))
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"S.shape"</span>, S.shape)

    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- Learn nearest neighbours</span>
    <span style="color: #cae682;">neigh</span> = NearestNeighbors(n_neighbors = k)
    neigh.fit(TFIXED)

    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"n_minority_samples"</span>, n_minority_samples) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">i - 0-&gt; rows</span>
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"N"</span>, N) <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">n - 0 -&gt; N</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- for each source row</span>
    <span style="color: #8ac6f2; font-weight: bold;">for</span> i <span style="color: #8ac6f2; font-weight: bold;">in</span> <span style="color: #e5786d;">range</span>(n_minority_samples): <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">per rows in source</span>
        <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- get most same rows</span>
        <span style="color: #cae682;">nn</span> = neigh.kneighbors([TFIXED[i]], return_distance=<span style="color: #e5786d; font-weight: bold;">False</span>)
        <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- repeat for how many we need</span>
        <span style="color: #8ac6f2; font-weight: bold;">for</span> n <span style="color: #8ac6f2; font-weight: bold;">in</span> <span style="color: #e5786d;">range</span>(NN): <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">2</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- what row we will copy</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">nn_index = nn[0][k-n-1]</span>
            <span style="color: #cae682;">nn_index</span> = nn[0][np.random.randint(1, k-1)]
            <span style="color: #fa8072;">#</span><span style="color: #99968b; font-style: italic;">NOTE: nn includes T[i], we don't want to select it</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">c = k-1</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">while nn_index == i:</span>
            <span style="color: #fa8072;">#     </span><span style="color: #99968b; font-style: italic;"># nn_index = choice(nn[0])</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- new row will be between this and same one.</span>
            <span style="color: #cae682;">dif</span> = T[nn_index] - T[i] <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">row</span>
            <span style="color: #cae682;">gap</span> = np.random.random()
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">[i,:] - row</span>
            <span style="color: #cae682;">S</span>[i*NN + n, :] = T[i,:] + gap * dif[:]
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">S[n + i, :] = T.iloc[i].to_numpy() + gap * dif[:]</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-i -n1</span>
            <span style="color: #fa8072;">#    </span><span style="color: #99968b; font-style: italic;">-n2</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-i -n1 2+1</span>
            <span style="color: #fa8072;">#    </span><span style="color: #99968b; font-style: italic;">-n2</span>
    <span style="color: #8ac6f2; font-weight: bold;">return</span> S

<span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">own</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> save
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> describe

<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train.pickle'</span>
<span style="color: #cae682;">p2</span> = <span style="color: #95e454;">'test.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #cae682;">df_small</span> = df[df[<span style="color: #95e454;">'tag'</span>] == 1]
<span style="color: #cae682;">df_small</span> = df_small.drop(columns=[<span style="color: #95e454;">'tag'</span>], inplace=<span style="color: #e5786d; font-weight: bold;">False</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">a = df_small[:1000].copy()</span>

<span style="color: #cae682;">smote_result</span> = SMOTE(df_small.to_numpy().copy(), 1600, 5)
<span style="color: #e5786d;">print</span>([<span style="color: #e5786d;">round</span>(x, 2) <span style="color: #8ac6f2; font-weight: bold;">for</span> x <span style="color: #8ac6f2; font-weight: bold;">in</span> smote_result[30]])
<span style="color: #e5786d;">print</span>()
<span style="color: #cae682;">smote_result_df</span> = pd.DataFrame(smote_result, columns=df_small.columns)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">describe(df_small, "df_small")</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">describe(smote_result_df, "smote_result_df")</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">- as we use only rare fclick records tag=1, that is why we set tag=1</span>
<span style="color: #cae682;">smote_result_df</span>[<span style="color: #95e454;">'tag'</span>] = 1
<span style="color: #e5786d;">print</span>()
<span style="color: #cae682;">df_over</span> = pd.concat([df, smote_result_df], ignore_index=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(df_over)</span>
<span style="color: #e5786d;">print</span>(df_over[<span style="color: #95e454;">'tag'</span>].value_counts())
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
save(p1, df_over)
</pre>
</div>

<pre class="example" id="org77b1223">
16.0 3044
48704 54
S.shape (48704, 54)
n_minority_samples 3044
N 1600
[1.91, 15.49, 0.41, 3.35, 1.63, 0.41, 16.2, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.07, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.18, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]


tag
0.0    52296
1.0    51748
Name: count, dtype: int64

-- ok -- train_over.pickle (104044, 55) ['tag', 'fc_imp_chk', 'fc_time_chk', 'utmtr', 'mm_dma', 'dayofweek', 'hour', 'month', 'quarter', 'osName', 'hardware', 'model_SM-G960U', 'model_SM-G965U', 'model_SM-G970U', 'model_SM-G973U', 'model_SM-G975U', 'model_SM-G986U', 'model_SM-G991U', 'model_SM-G998U', 'model_SM-N975U', 'model_SM-N986U', 'model_iPhone', 'model_iPhone 11', 'model_iPhone 11 Pro Max', 'model_iPhone 12', 'model_iPhone 12 Pro', 'model_iPhone 12 Pro Max', 'model_iPhone 8 Plus', 'model_iPhone XR', 'model_other', 'site_id_currently.att.yahoo.com', 'site_id_finance.yahoo.com', 'site_id_heavy.com', 'site_id_hu.motorsport.com', 'site_id_metropcs.mobileposse.com', 'site_id_my.xfinity.com', 'site_id_myfox8.com', 'site_id_news.yahoo.com', 'site_id_nypost.com', 'site_id_people.com', 'site_id_stocktwits.com', 'site_id_tbc.wowhead.com', 'site_id_thespun.com', 'site_id_whatculture.com', 'site_id_whnt.com', 'site_id_www.dailymotion.com', 'site_id_www.digitalspy.com', 'site_id_www.elle.com', 'site_id_www.foxbusiness.com', 'site_id_www.stltoday.com', 'site_id_www.wane.com', 'site_id_www.woodtv.com', 'site_id_www.wowhead.com', 'site_id_www.yahoo.com', 'site_id_other']
</pre>
</div>
</div>

<div id="outline-container-org9cb6ced" class="outline-3">
<h3 id="org9cb6ced"><span class="section-number-3">4.4.</span> zero classifier for oversampled</h3>
<div class="outline-text-3" id="text-4-4">
<p>
We have highly skewed class distributions.
It is unbalanced classification.
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.dummy <span style="color: #8ac6f2; font-weight: bold;">import</span> DummyClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> get_scorer
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">own</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load

<span style="color: #cae682;">random_state</span> = 42
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfx = pd.read_csv('interview.X.csv')</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfy = pd.read_csv('interview.y.csv')</span>
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #e5786d;">print</span>(df.shape)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">dfx = dfx.sample(frac=0.05, random_state=42)</span>
<span style="color: #e5786d;">print</span>(df.head(5).to_string())
<span style="color: #e5786d;">print</span>()
<span style="color: #cae682;">y</span> = df[<span style="color: #95e454;">'tag'</span>]
<span style="color: #cae682;">X</span> = df.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(X.columns.tolist())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(y)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">----------- select metrics 1) dummy ----</span>

<span style="color: #cae682;">dummy_clf</span> = DummyClassifier(random_state = random_state)
dummy_clf.fit(X, y)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"dummy classifier metrics on train data:"</span>)
<span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> [<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>, <span style="color: #95e454;">'precision'</span>, <span style="color: #95e454;">'recall'</span>, <span style="color: #95e454;">'f1'</span>]:
    <span style="color: #cae682;">s</span> = get_scorer(k)
    <span style="color: #cae682;">y_pred</span> = dummy_clf.predict(X)
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'{:40} {:5}'</span>.<span style="color: #e5786d;">format</span>(k, s._score_func(y.to_numpy(), y_pred)))
dummy_clf.predict(X)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'---'</span>)
<span style="color: #cae682;">v</span> = dummy_clf.predict(X)
<span style="color: #e5786d;">print</span>(<span style="color: #e5786d;">sum</span>(v))
</pre>
</div>

<pre class="example" id="org5b07511">
(104044, 55)
   tag  fc_imp_chk  fc_time_chk  utmtr  mm_dma  dayofweek  hour  month  quarter  osName  hardware  model_SM-G960U  model_SM-G965U  model_SM-G970U  model_SM-G973U  model_SM-G975U  model_SM-G986U  model_SM-G991U  model_SM-G998U  model_SM-N975U  model_SM-N986U  model_iPhone  model_iPhone 11  model_iPhone 11 Pro Max  model_iPhone 12  model_iPhone 12 Pro  model_iPhone 12 Pro Max  model_iPhone 8 Plus  model_iPhone XR  model_other  site_id_currently.att.yahoo.com  site_id_finance.yahoo.com  site_id_heavy.com  site_id_hu.motorsport.com  site_id_metropcs.mobileposse.com  site_id_my.xfinity.com  site_id_myfox8.com  site_id_news.yahoo.com  site_id_nypost.com  site_id_people.com  site_id_stocktwits.com  site_id_tbc.wowhead.com  site_id_thespun.com  site_id_whatculture.com  site_id_whnt.com  site_id_www.dailymotion.com  site_id_www.digitalspy.com  site_id_www.elle.com  site_id_www.foxbusiness.com  site_id_www.stltoday.com  site_id_www.wane.com  site_id_www.woodtv.com  site_id_www.wowhead.com  site_id_www.yahoo.com  site_id_other
0  0.0         0.0          7.0    0.0   630.0        3.0   0.0    7.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          1.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
1  0.0         0.0          7.0    0.0   501.0        4.0   2.0    7.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            1.0
2  0.0         0.0          7.0    5.0   609.0        4.0  16.0    7.0      3.0     0.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           0.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          1.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 1.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
3  0.0         0.0          7.0    0.0   551.0        0.0   1.0    8.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           1.0              0.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          1.0                         0.0                   0.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0
4  0.0         0.0          7.0    5.0   510.0        6.0  17.0    8.0      3.0     1.0       0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0             0.0           0.0              1.0                      0.0              0.0                  0.0                      0.0                  0.0              0.0          0.0                              0.0                        0.0                0.0                        0.0                               0.0                     0.0                 0.0                     0.0                 0.0                 0.0                     0.0                      0.0                  0.0                      0.0               0.0                          0.0                         0.0                   1.0                          0.0                       0.0                   0.0                     0.0                      0.0                    0.0            0.0

dummy classifier metrics on train data:
accuracy                                 0.5026335012110261
roc_auc                                    0.5
precision                                  0.0
recall                                     0.0
f1                                         0.0
---
0.0
</pre>
</div>
</div>

<div id="outline-container-org452d119" class="outline-3">
<h3 id="org452d119"><span class="section-number-3">4.5.</span> selection of metric</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> warnings
warnings.filterwarnings(<span style="color: #95e454;">"ignore"</span>, category=<span style="color: #92a65e; font-weight: bold;">Warning</span>)
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> cross_val_score, cross_validate
<span style="color: #8ac6f2; font-weight: bold;">import</span> numpy <span style="color: #8ac6f2; font-weight: bold;">as</span> np

<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.dummy <span style="color: #8ac6f2; font-weight: bold;">import</span> DummyClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.neural_network <span style="color: #8ac6f2; font-weight: bold;">import</span> MLPClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> StratifiedKFold
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn <span style="color: #8ac6f2; font-weight: bold;">import</span> metrics
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> make_scorer
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> (
    accuracy_score,
    balanced_accuracy_score,
    brier_score_loss,
    class_likelihood_ratios,
    classification_report,
    cohen_kappa_score,
    confusion_matrix,
    f1_score,
    fbeta_score,
    hamming_loss,
    hinge_loss,
    jaccard_score,
    log_loss,
    matthews_corrcoef,
    multilabel_confusion_matrix,
    precision_recall_fscore_support,
    precision_score,
    recall_score,
    zero_one_loss,

    auc,
    average_precision_score,
    coverage_error,
    dcg_score,
    det_curve,
    label_ranking_average_precision_score,
    label_ranking_loss,
    ndcg_score,
    precision_recall_curve,
    roc_auc_score,
    roc_curve,
    top_k_accuracy_score)

<span style="color: #cae682;">cl1</span> = [accuracy_score,
    balanced_accuracy_score,
    brier_score_loss,
    class_likelihood_ratios,
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">classification_report,</span>
    cohen_kappa_score,
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">confusion_matrix,</span>
    f1_score,
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">fbeta_score,</span>
    hamming_loss,
    hinge_loss,
    jaccard_score,
    log_loss,
    matthews_corrcoef,
    multilabel_confusion_matrix,
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">precision_recall_fscore_support,</span>
    precision_score,
    recall_score,
    zero_one_loss,
    auc,
    average_precision_score,
    coverage_error,
    dcg_score,
    det_curve,
    label_ranking_average_precision_score,
    label_ranking_loss,
    ndcg_score,
    precision_recall_curve,
    roc_auc_score,
    roc_curve,
    top_k_accuracy_score]


<span style="color: #8ac6f2; font-weight: bold;">def</span> <span style="color: #cae682; font-weight: bold;">_select_metrics</span>(est1, est2, X, Y, kfold):
    <span style="color: #e5786d;">print</span>( <span style="color: #95e454;">'{:40} {:5} {:5}'</span>.<span style="color: #e5786d;">format</span>(<span style="color: #95e454;">"metric"</span>, <span style="color: #95e454;">"dummy model"</span>, <span style="color: #95e454;">"one of effective model"</span> ))
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print( '{:40} {:5} {:5}'.format("metric", "mean_accuracy", "std" ))</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">for k in metrics.get_scorer_names():</span>
    <span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> cl1:
        <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print("w", k)</span>
        <span style="color: #8ac6f2; font-weight: bold;">try</span>:
            <span style="color: #cae682;">r1</span> = cross_val_score(est1, X, y, cv=5, scoring=make_scorer(k))
            <span style="color: #cae682;">r2</span> = cross_val_score(est2, X, y, cv=5, scoring=make_scorer(k))
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(r1.mean(), r2.mean())</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(k.__name__, round(r1.mean(), 3))</span>
            <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'{:40} {:5}</span><span style="color: #e5786d; font-weight: bold;">\t\t</span><span style="color: #95e454;">{:5}'</span>.<span style="color: #e5786d;">format</span>(k.<span style="color: #e5786d;">__name__</span>, <span style="color: #e5786d;">round</span>(r1.mean(), 3), <span style="color: #e5786d;">round</span>(r2.mean(), 3)) )
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(np.mean(r1), np.mean(r2))</span>
            <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print('{:40} {:5} {:5}\t{:5} {:5}'.format(k.__name__, round(r1.mean(), 3), round(r1.std(),2), round(r2.mean(), 3), round(r2.std(),2)) )</span>
        <span style="color: #8ac6f2; font-weight: bold;">except</span>:
            <span style="color: #8ac6f2; font-weight: bold;">pass</span>



<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #cae682;">df</span> = df.sample(frac=0.03, random_state=42)
<span style="color: #e5786d;">print</span>(df.shape)
<span style="color: #cae682;">y</span> = df[<span style="color: #95e454;">'tag'</span>]
<span style="color: #cae682;">X</span> = df.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"y.unique()"</span>, y.unique())
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"y.isna().sum()"</span>, y.isna().<span style="color: #e5786d;">sum</span>())

<span style="color: #cae682;">dummy_clf</span> = DummyClassifier()
dummy_clf.fit(X, y)
<span style="color: #8ac6f2; font-weight: bold;">import</span> sklearn.ensemble
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">m = sklearn.ensemble.AdaBoostClassifier() # MLPClassifier(max_iter=10, random_state=1, early_stopping=True)</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.neighbors <span style="color: #8ac6f2; font-weight: bold;">import</span> KNeighborsClassifier
<span style="color: #cae682;">m</span> = KNeighborsClassifier(3)
<span style="color: #cae682;">kfold</span> = StratifiedKFold(n_splits=5)
_select_metrics(dummy_clf, m, X, y, kfold)
</pre>
</div>

<pre class="example" id="org5b6eb08">
(3121, 55)
y.unique() [0. 1.]
y.isna().sum() 0
metric                                   dummy model one of effective model
accuracy_score                           0.522		0.657
balanced_accuracy_score                    0.5		0.655
brier_score_loss                         0.478		0.343
cohen_kappa_score                          0.0		0.311
f1_score                                   0.0		0.637
hamming_loss                             0.478		0.343
hinge_loss                                 1.0		0.866
jaccard_score                              0.0		0.467
log_loss                                 17.219		12.38
matthews_corrcoef                          0.0		0.311
precision_score                            0.0		0.644
recall_score                               0.0		 0.63
zero_one_loss                            0.478		0.343
auc                                        nan		  nan
average_precision_score                  0.478		0.582
coverage_error                             nan		  nan
dcg_score                                  nan		  nan
label_ranking_average_precision_score      nan		  nan
label_ranking_loss                         nan		  nan
ndcg_score                                 nan		  nan
roc_auc_score                              0.5		0.655
top_k_accuracy_score                       1.0		  1.0
</pre>
</div>
</div>

<div id="outline-container-org7b976b5" class="outline-3">
<h3 id="org7b976b5"><span class="section-number-3">4.6.</span> correlation analysis + Variance Inflation Factor</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">from</span> statsmodels.stats.outliers_influence <span style="color: #8ac6f2; font-weight: bold;">import</span> variance_inflation_factor
<span style="color: #8ac6f2; font-weight: bold;">from</span> statsmodels.tools.tools <span style="color: #8ac6f2; font-weight: bold;">import</span> add_constant
<span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.exploring <span style="color: #8ac6f2; font-weight: bold;">import</span> corr_analysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load

<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #e5786d;">print</span>(df.shape)
<span style="color: #cae682;">df</span> = df.sample(frac=0.01, random_state=42)
<span style="color: #cae682;">y</span> = df[<span style="color: #95e454;">'tag'</span>]
<span style="color: #cae682;">X</span> = df.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"variance_inflation_factor:"</span>)
<span style="color: #e5786d;">print</span>(pd.Series([variance_inflation_factor(df.values, i) <span style="color: #8ac6f2; font-weight: bold;">for</span> i <span style="color: #8ac6f2; font-weight: bold;">in</span>
                 <span style="color: #e5786d;">range</span>(df.shape[1])], index=df.columns))
<span style="color: #e5786d;">print</span>()
corr_analysis(df, target = <span style="color: #95e454;">'tag'</span>)
</pre>
</div>

<pre class="example" id="orga20ee20">
(104044, 55)
variance_inflation_factor:
tag                                  1.457861
fc_imp_chk                           4.597327
fc_time_chk                          4.956993
utmtr                               90.957306
mm_dma                               1.969561
dayofweek                            1.192101
hour                                90.925846
month                                3.593256
quarter                              0.000000
osName                              16.839983
hardware                             5.082756
model_SM-G960U                            inf
model_SM-G965U                            inf
model_SM-G970U                            inf
model_SM-G973U                            inf
model_SM-G975U                            inf
model_SM-G986U                            inf
model_SM-G991U                            inf
model_SM-G998U                            inf
model_SM-N975U                            inf
model_SM-N986U                            inf
model_iPhone                              inf
model_iPhone 11                           inf
model_iPhone 11 Pro Max                   inf
model_iPhone 12                           inf
model_iPhone 12 Pro                       inf
model_iPhone 12 Pro Max                   inf
model_iPhone 8 Plus                       inf
model_iPhone XR                           inf
model_other                               inf
site_id_currently.att.yahoo.com           inf
site_id_finance.yahoo.com                 inf
site_id_heavy.com                         inf
site_id_hu.motorsport.com                 inf
site_id_metropcs.mobileposse.com          inf
site_id_my.xfinity.com                    inf
site_id_myfox8.com                        inf
site_id_news.yahoo.com                    inf
site_id_nypost.com                        inf
site_id_people.com                        inf
site_id_stocktwits.com                    inf
site_id_tbc.wowhead.com                   inf
site_id_thespun.com                       inf
site_id_whatculture.com                   inf
site_id_whnt.com                          inf
site_id_www.dailymotion.com               inf
site_id_www.digitalspy.com                inf
site_id_www.elle.com                      inf
site_id_www.foxbusiness.com               inf
site_id_www.stltoday.com                  inf
site_id_www.wane.com                      inf
site_id_www.woodtv.com                    inf
site_id_www.wowhead.com                   inf
site_id_www.yahoo.com                     inf
site_id_other                             inf
dtype: float64

correlation to target
site_id_other                      -0.236824
site_id_www.dailymotion.com        -0.230116
model_iPhone                       -0.201054
osName                             -0.149640
fc_time_chk                        -0.132403
site_id_my.xfinity.com             -0.101979
site_id_finance.yahoo.com          -0.097590
site_id_www.wowhead.com            -0.077699
mm_dma                             -0.074184
site_id_heavy.com                  -0.071901
site_id_metropcs.mobileposse.com   -0.065604
site_id_thespun.com                -0.058650
site_id_tbc.wowhead.com            -0.058650
dayofweek                          -0.058594
site_id_people.com                 -0.053524
site_id_stocktwits.com             -0.050768
site_id_currently.att.yahoo.com    -0.046594
model_iPhone 11 Pro Max            -0.046594
model_iPhone 12 Pro Max            -0.046466
model_iPhone 12                    -0.046466
site_id_www.foxbusiness.com        -0.041432
site_id_www.yahoo.com              -0.040006
model_iPhone XR                    -0.039008
site_id_www.stltoday.com           -0.039008
site_id_news.yahoo.com             -0.037756
model_iPhone 11                    -0.029831
site_id_www.elle.com               -0.027912
model_iPhone 8 Plus                 0.016537
model_SM-G970U                      0.027136
model_iPhone 12 Pro                 0.029836
model_SM-G960U                      0.032509
model_SM-G998U                      0.038526
model_SM-G986U                      0.046196
model_SM-G965U                      0.049184
site_id_hu.motorsport.com           0.049847
model_SM-G991U                      0.054536
model_SM-G973U                      0.058888
hour                                0.064178
site_id_whnt.com                    0.064207
model_SM-N986U                      0.064912
utmtr                               0.068455
site_id_www.woodtv.com              0.074560
model_SM-N975U                      0.078392
site_id_www.digitalspy.com          0.079134
site_id_www.wane.com                0.080705
fc_imp_chk                          0.112131
model_other                         0.112430
model_SM-G975U                      0.128164
site_id_myfox8.com                  0.135860
hardware                            0.140603
site_id_nypost.com                  0.204175
month                               0.224128
site_id_whatculture.com             0.226088
tag                                 1.000000
quarter                                  NaN

correlation max() per column:
                                   0         1
8                            quarter  0.000000
40            site_id_stocktwits.com  0.050768
41           site_id_tbc.wowhead.com  0.058650
53             site_id_www.yahoo.com  0.067603
52           site_id_www.wowhead.com  0.077699
49          site_id_www.stltoday.com  0.081065
25               model_iPhone 12 Pro  0.082985
50              site_id_www.wane.com  0.087051
35            site_id_my.xfinity.com  0.101979
34  site_id_metropcs.mobileposse.com  0.110402
30   site_id_currently.att.yahoo.com  0.110596
12                    model_SM-G965U  0.111783
13                    model_SM-G970U  0.111783
22                   model_iPhone 11  0.117701
26           model_iPhone 12 Pro Max  0.118106
39                site_id_people.com  0.122595
51            site_id_www.woodtv.com  0.134684
14                    model_SM-G973U  0.147587
27               model_iPhone 8 Plus  0.149003
32                 site_id_heavy.com  0.149003
15                    model_SM-G975U  0.153587
31         site_id_finance.yahoo.com  0.157568
23           model_iPhone 11 Pro Max  0.162393
47              site_id_www.elle.com  0.162393
19                    model_SM-N975U  0.176429
20                    model_SM-N986U  0.182534
17                    model_SM-G991U  0.190930
24                   model_iPhone 12  0.200377
42               site_id_thespun.com  0.200377
44                  site_id_whnt.com  0.211724
16                    model_SM-G986U  0.211724
18                    model_SM-G998U  0.214250
5                          dayofweek  0.219067
36                site_id_myfox8.com  0.231223
0                                tag  0.236824
46        site_id_www.digitalspy.com  0.240189
37            site_id_news.yahoo.com  0.242417
11                    model_SM-G960U  0.242417
28                   model_iPhone XR  0.247344
48       site_id_www.foxbusiness.com  0.247344
45       site_id_www.dailymotion.com  0.260353
54                     site_id_other  0.345493
33         site_id_hu.motorsport.com  0.417683
4                             mm_dma  0.448785
10                          hardware  0.448785
7                              month  0.555660
43           site_id_whatculture.com  0.619393
38                site_id_nypost.com  0.634801
29                       model_other  0.685469
9                             osName  0.754019
21                      model_iPhone  0.754019
2                        fc_time_chk  0.870653
1                         fc_imp_chk  0.870653
6                               hour  0.994080
3                              utmtr  0.994080
</pre>
</div>
</div>

<div id="outline-container-org4ae4d9f" class="outline-3">
<h3 id="org4ae4d9f"><span class="section-number-3">4.7.</span> seletion of model</h3>
<div class="outline-text-3" id="text-4-7">
</div>
<div id="outline-container-orgba9b4ec" class="outline-4">
<h4 id="orgba9b4ec"><span class="section-number-4">4.7.1.</span> Algorithm to choose from:</h4>
<div class="outline-text-4" id="text-4-7-1">
<ol class="org-ol">
<li>Decision Trees - for categorical and numerical data, high-dimensional.</li>
<li>Logistic Regression - for linear relationship, to model the
probability of a binary or categorical outcome</li>
<li>Naive Bayes - fast and simple model for classification tasks, for
high-dimensional data or data with many categorical features. Support
Out-of-core learning.</li>
<li>K-Nearest Neighbors (KNN) - non-parametric model that can handle
both classification and regression tasks, non-linear relationship.</li>
<li>Support Vector Machines (SVM) - for many features, but few samples, memory efficient</li>
<li>Random Forests - for high-dimensional data or data with missing values.</li>
<li>Gradient Boosting Machines (GBM)</li>
<li>Neural Networks (Deep Learning) - data that has many layers of
abstraction or complex interactions between features.</li>
</ol>
</div>
</div>
<div id="outline-container-org102a5c2" class="outline-4">
<h4 id="org102a5c2"><span class="section-number-4">4.7.2.</span> criterions:</h4>
<div class="outline-text-4" id="text-4-7-2">
<ul class="org-ul">
<li>time or quality of development? - medium.</li>
<li>resources available? - very limited.</li>
<li>processing speed required? - no limits</li>
<li>Type of data: tabular or unstructured. - Tabular.</li>
<li>Time-series or not? - Not.</li>
<li>Graph or not? - Not.</li>
<li>sparsity of data? - No sparsity.</li>
<li>Size of the training data, n_samples &gt;= 9000 &lt;= 99000? - medium.</li>
<li>Accuracy versus Interpretability tradeoff. - Accuracy.</li>
<li>Speed and Training Time? - No Speed required, training time may be large.</li>
<li>Linearity - classes can be sepparated by straight line or data
follow straight line?</li>
<li>amount of multicollinearity in features. - have some.</li>
<li>underlying distribution</li>
</ul>

<p>
tradeoffs:
</p>
<ul class="org-ul">
<li>computationally efficient, simple and interpretable vs complex and more universal.
<ul class="org-ul">
<li><p>
criterions:
</p>
<ul class="org-ul">
<li>robust to outliers and missing data.</li>
<li>data: relationship between input and output variables is linear or</li>
</ul>
<p>
non-linear, multicollinearity in features, sparsity of data.
</p></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org0b6f1ab" class="outline-4">
<h4 id="org0b6f1ab"><span class="section-number-4">4.7.3.</span> multicollinearity criterion</h4>
<div class="outline-text-4" id="text-4-7-3">
<p>
affected:
</p>
<ol class="org-ol">
<li>Logistic Regression</li>
<li>Naive Bayes - not much</li>
<li>K-Nearest Neighbors (KNN) - not directly, may dominate the distance calculation and bias the results</li>
<li>Gradient Boosting Machines (GBM)</li>
</ol>

<p>
multicollinearity criterion not affected:
</p>
<ol class="org-ol">
<li>Decision Trees</li>
<li>Support Vector Machines (SVM) - not directly, may lead to overfitting or underfitting of the model.</li>
<li>Random Forests</li>
<li>Neural Networks (Deep Learning) - must be deep enough.</li>
</ol>
</div>
</div>

<div id="outline-container-org98d8810" class="outline-4">
<h4 id="org98d8810"><span class="section-number-4">4.7.4.</span> experiments</h4>
<div class="outline-text-4" id="text-4-7-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load
<span style="color: #fa8072;">#</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> cross_val_score, cross_validate
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> StratifiedKFold
<span style="color: #fa8072;">#</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.discriminant_analysis <span style="color: #8ac6f2; font-weight: bold;">import</span> QuadraticDiscriminantAnalysis
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.ensemble <span style="color: #8ac6f2; font-weight: bold;">import</span> AdaBoostClassifier, RandomForestClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.gaussian_process <span style="color: #8ac6f2; font-weight: bold;">import</span> GaussianProcessClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.gaussian_process.kernels <span style="color: #8ac6f2; font-weight: bold;">import</span> RBF
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.inspection <span style="color: #8ac6f2; font-weight: bold;">import</span> DecisionBoundaryDisplay
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> train_test_split
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.naive_bayes <span style="color: #8ac6f2; font-weight: bold;">import</span> GaussianNB
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.neighbors <span style="color: #8ac6f2; font-weight: bold;">import</span> KNeighborsClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.neural_network <span style="color: #8ac6f2; font-weight: bold;">import</span> MLPClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.pipeline <span style="color: #8ac6f2; font-weight: bold;">import</span> make_pipeline
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.preprocessing <span style="color: #8ac6f2; font-weight: bold;">import</span> StandardScaler
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.svm <span style="color: #8ac6f2; font-weight: bold;">import</span> SVC
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.tree <span style="color: #8ac6f2; font-weight: bold;">import</span> DecisionTreeClassifier


<span style="color: #8ac6f2; font-weight: bold;">def</span> <span style="color: #cae682; font-weight: bold;">_check_model_binary</span>(est, X, Y, kfold):
    <span style="color: #cae682;">results</span> = cross_validate(est, X, Y, cv=kfold, scoring=[<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>])
    <span style="color: #e5786d;">print</span>(est.__class__.<span style="color: #e5786d;">__name__</span>)
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"Accuracy: %f"</span> % results[<span style="color: #95e454;">'test_accuracy'</span>].mean())
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"AUC: %f"</span> % results[<span style="color: #95e454;">'test_roc_auc'</span>].mean())
    <span style="color: #e5786d;">print</span>()


<span style="color: #cae682;">classifiers</span> = [
    KNeighborsClassifier(3),
    SVC(kernel=<span style="color: #95e454;">"linear"</span>, C=0.025, random_state=42),
    SVC(gamma=2, C=1, random_state=42),
    GaussianProcessClassifier(1.0 * RBF(1.0), random_state=42),
    DecisionTreeClassifier(max_depth=5, random_state=42),
    RandomForestClassifier(
        max_depth=5, n_estimators=10, max_features=1, random_state=42
    ),
    MLPClassifier(alpha=1, max_iter=1000, random_state=42),
    AdaBoostClassifier(random_state=42),
    GaussianNB(),
    QuadraticDiscriminantAnalysis()
]

<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df</span> = load(p1)
<span style="color: #cae682;">df</span> = df.sample(frac=0.0001, random_state=42)
<span style="color: #e5786d;">print</span>(df.shape)
<span style="color: #cae682;">y</span> = df[<span style="color: #95e454;">'tag'</span>]
<span style="color: #cae682;">X</span> = df.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.preprocessing <span style="color: #8ac6f2; font-weight: bold;">import</span> StandardScaler
<span style="color: #cae682;">X</span> = StandardScaler().fit_transform(X)

<span style="color: #cae682;">kfold</span> = StratifiedKFold(n_splits=5)
<span style="color: #8ac6f2; font-weight: bold;">for</span> est <span style="color: #8ac6f2; font-weight: bold;">in</span> classifiers:
    _check_model_binary(est, X, y, kfold)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">m = OneVsOneClassifier(sklearn.ensemble.AdaBoostClassifier())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">_select_metrics(dummy_clf, m, X, y, kfold)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">for est in classifiers_multiclass_nativ: # classifiers_multiclass_ovo:</span>
<span style="color: #fa8072;">#     </span><span style="color: #99968b; font-style: italic;">_check_model_multiclass_native(est, X, y, kfold)</span>
</pre>
</div>

<pre class="example" id="orgaf4ba0f">
(10, 55)
KNeighborsClassifier
Accuracy: 0.400000
AUC: 0.400000

SVC
Accuracy: 0.200000
AUC: 0.200000

SVC
Accuracy: 0.600000
AUC: 0.600000

GaussianProcessClassifier
Accuracy: 0.600000
AUC: 0.600000

DecisionTreeClassifier
Accuracy: 0.100000
AUC: 0.100000

RandomForestClassifier
Accuracy: 0.300000
AUC: 0.100000

MLPClassifier
Accuracy: 0.300000
AUC: 0.400000

AdaBoostClassifier
Accuracy: 0.200000
AUC: 0.100000

GaussianNB
Accuracy: 0.400000
AUC: 0.400000

QuadraticDiscriminantAnalysis
Accuracy: 0.400000
AUC: 0.200000
</pre>
</div>
</div>
<div id="outline-container-org55c6275" class="outline-4">
<h4 id="org55c6275"><span class="section-number-4">4.7.5.</span> result</h4>
<div class="outline-text-4" id="text-4-7-5">
<p>
We choose Random Forests.
</p>
</div>
</div>
</div>
<div id="outline-container-org289329d" class="outline-3">
<h3 id="org289329d"><span class="section-number-3">4.8.</span> model finetuning and training</h3>
<div class="outline-text-3" id="text-4-8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.ensemble <span style="color: #8ac6f2; font-weight: bold;">import</span> AdaBoostClassifier, RandomForestClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> GridSearchCV
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> cross_val_score
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> cross_validate
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.multiclass <span style="color: #8ac6f2; font-weight: bold;">import</span> OneVsOneClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> LeaveOneOut
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.experimental <span style="color: #8ac6f2; font-weight: bold;">import</span> enable_halving_search_cv
<span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #8ac6f2; font-weight: bold;">import</span> time
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> get_scorer
<span style="color: #fa8072;">#</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load

<span style="color: #cae682;">random_state</span> = 42

<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> (
    accuracy_score,
    f1_score,
    precision_score,
    recall_score)


<span style="color: #8ac6f2; font-weight: bold;">def</span> <span style="color: #cae682; font-weight: bold;">forest_search_parameters</span>(p, target:<span style="color: #e5786d;">str</span>=<span style="color: #95e454;">'target'</span>):
    <span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.ensemble <span style="color: #8ac6f2; font-weight: bold;">import</span> RandomForestClassifier
    <span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> GridSearchCV
    <span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> HalvingGridSearchCV
    <span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> StratifiedKFold, KFold
    <span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> cross_val_score
    <span style="color: #cae682;">X</span> = df.drop(columns=[target])
    <span style="color: #cae682;">y</span> = df[target]

    <span style="color: #cae682;">kfold</span> = StratifiedKFold(n_splits=5)
    <span style="color: #cae682;">params</span> = { <span style="color: #95e454;">'min_samples_split'</span>: [5], <span style="color: #fa8072;">#</span><span style="color: #99968b; font-style: italic;">'n_estimators': [5, 10, 15],</span>
              <span style="color: #95e454;">'max_leaf_nodes'</span>: <span style="color: #e5786d;">list</span>(<span style="color: #e5786d;">range</span>(20, 25)), <span style="color: #95e454;">'max_depth'</span>: <span style="color: #e5786d;">list</span>(<span style="color: #e5786d;">range</span>(13, 17))}
    <span style="color: #cae682;">base_estimator</span> = RandomForestClassifier()
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">clf = GridSearchCV(base_estimator, params, cv=kfold)</span>
    <span style="color: #cae682;">clf</span> = HalvingGridSearchCV(base_estimator, params, cv=kfold,
                              factor=3, resource=<span style="color: #95e454;">'n_estimators'</span>,
                              max_resources=30, random_state=42)
    clf.fit(X, y)
    <span style="color: #e5786d;">print</span>(clf.best_estimator_)
    <span style="color: #e5786d;">print</span>(clf.best_params_)
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">est_params = clf.best_estimator_</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- cross validate on training dataset</span>
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"train metrics:"</span>)
    <span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> [<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>, <span style="color: #95e454;">'precision'</span>, <span style="color: #95e454;">'recall'</span>, <span style="color: #95e454;">'f1'</span>]:
        <span style="color: #cae682;">s</span> = get_scorer(k)
        <span style="color: #cae682;">results</span> = cross_val_score(clf.best_estimator_, X, y, cv=kfold,
                                  scoring=s)
        <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"{}: {}"</span>.<span style="color: #e5786d;">format</span>(k, results.mean()))
    <span style="color: #e5786d;">print</span>()
    <span style="color: #8ac6f2; font-weight: bold;">return</span> clf.best_estimator_, clf.best_params_


<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df</span>: pd.DataFrame = load(p1)
<span style="color: #cae682;">df</span> = df.sample(frac=0.2, random_state=42)

<span style="color: #cae682;">start_time</span> = time.time()
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- find parameters</span>
<span style="color: #cae682;">est</span>, <span style="color: #cae682;">est_params</span> = forest_search_parameters(p1, <span style="color: #95e454;">'tag'</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">results = clf.fit(X, y)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">est = results.best_estimator_</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(est)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">kfold = LeaveOneOut()</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">results = cross_val_score(results.best_estimator_, X, y, cv=kfold)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print("Accuracy: %f" % results.mean())</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(results)</span>

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">scoring=['accuracy', 'precision_macro',</span>
<span style="color: #fa8072;">#                                       </span><span style="color: #99968b; font-style: italic;">'recall_macro']</span>

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">results = cross_validate(est, X, y, cv=kfold, scoring=scoring) #</span>


<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">for x in scoring:</span>
<span style="color: #fa8072;">#     </span><span style="color: #99968b; font-style: italic;">print(x+ ": %f" % results['test_'+x].mean())</span>
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"--- %s seconds ---"</span> % (time.time() - start_time))
</pre>
</div>

<pre class="example" id="orgb8cf927">
RandomForestClassifier(max_depth=14, max_leaf_nodes=24, min_samples_split=5,
                       n_estimators=27)
{'max_depth': 14, 'max_leaf_nodes': 24, 'min_samples_split': 5, 'n_estimators': 27}
train metrics:
accuracy: 0.9699169111221441
roc_auc: 0.9864212907136707
precision: 0.9996879832896994
recall: 0.9391772771792362
f1: 0.9685841799451971

--- 24.099985122680664 seconds ---
</pre>

<p>
##+RESULTS: nov 5
</p>
<pre class="example" id="org965b599">
RandomForestClassifier(max_depth=12, max_leaf_nodes=14, min_samples_split=4,
                       n_estimators=27)
{'max_depth': 12, 'max_leaf_nodes': 14, 'min_samples_split': 4, 'n_estimators': 27}
train metrics:
accuracy: 0.8109954901472346
roc_auc: 0.9040743930689077
precision: 0.7670022280115995
recall: 0.8890303623898139
f1: 0.8201224929403879

--- 31.76545810699463 seconds ---
</pre>
</div>
</div>
<div id="outline-container-orgaa862c0" class="outline-3">
<h3 id="orgaa862c0"><span class="section-number-3">4.9.</span> test or validation of model</h3>
<div class="outline-text-3" id="text-4-9">
<p>
We uses "est_params" variable here from <a href="#org289329d">4.8</a>
</p>
<pre class="example">
{'max_depth': 12, 'max_leaf_nodes': 14, 'min_samples_split': 4, 'n_estimators': 27}
</pre>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">import</span> warnings
warnings.filterwarnings(<span style="color: #95e454;">"ignore"</span>, category=<span style="color: #92a65e; font-weight: bold;">Warning</span>)
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> get_scorer
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.dummy <span style="color: #8ac6f2; font-weight: bold;">import</span> DummyClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.ensemble <span style="color: #8ac6f2; font-weight: bold;">import</span> RandomForestClassifier
<span style="color: #8ac6f2; font-weight: bold;">import</span> pandas <span style="color: #8ac6f2; font-weight: bold;">as</span> pd
<span style="color: #fa8072;">#</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load

<span style="color: #cae682;">est_params</span> = {<span style="color: #95e454;">'max_depth'</span>: 14, <span style="color: #95e454;">'max_leaf_nodes'</span>: 24, <span style="color: #95e454;">'min_samples_split'</span>: 5, <span style="color: #95e454;">'n_estimators'</span>: 27}

<span style="color: #cae682;">random_state</span> = 42
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df_train</span>: pd.DataFrame = load(p1)

<span style="color: #cae682;">p2</span> = <span style="color: #95e454;">'test.pickle'</span>
<span style="color: #cae682;">df_test</span> = load(p1)

<span style="color: #cae682;">target</span> = <span style="color: #95e454;">'tag'</span>
<span style="color: #cae682;">X_train</span> = df_train.drop(columns=[target])
<span style="color: #cae682;">y_train</span> = df_train[target]

<span style="color: #cae682;">X_test</span> = df_test.drop(columns=[target])
<span style="color: #cae682;">y_test</span> = df_test[target]
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- train on training dataset and validate on validation dataset</span>
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"test metrics:"</span>)
<span style="color: #e5786d;">print</span>(est_params)
est_params.update({<span style="color: #95e454;">'random_state'</span>:random_state})
<span style="color: #cae682;">est</span> = RandomForestClassifier(**est_params)
<span style="color: #e5786d;">print</span>(est)
est.fit(X_train, y_train)
<span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> [<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>, <span style="color: #95e454;">'precision'</span>, <span style="color: #95e454;">'recall'</span>, <span style="color: #95e454;">'f1'</span>]:
    <span style="color: #cae682;">s</span> = get_scorer(k)
    <span style="color: #cae682;">y_pred</span> = est.predict(X_test)
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'{:40} {:5}'</span>.<span style="color: #e5786d;">format</span>(k, s._score_func(y_test, y_pred)))
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(k, s._score_func(y_test, y_pred)) # , average='binary'</span>
<span style="color: #e5786d;">print</span>()
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- compare with zero Dummy</span>
<span style="color: #cae682;">estd</span> = DummyClassifier(random_state=random_state)
estd.fit(X_train, y_train)
<span style="color: #e5786d;">print</span>(<span style="color: #95e454;">"test metrics for Dummy classifier:"</span>)
<span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> [<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>, <span style="color: #95e454;">'precision'</span>, <span style="color: #95e454;">'recall'</span>, <span style="color: #95e454;">'f1'</span>]:
    <span style="color: #cae682;">s</span> = get_scorer(k)
    <span style="color: #cae682;">y_pred</span> = estd.predict(X_test)
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(y_pred)</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(y_test.to_numpy())</span>
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(s._score_func(y_test.to_numpy(), y_pred))</span>
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'{:40} {:5}'</span>.<span style="color: #e5786d;">format</span>(k, s._score_func(y_test.to_numpy(), y_pred)))
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(k, s._score_func(y_test, y_pred)) # , average='binary'</span>
</pre>
</div>

<pre class="example" id="orgb5241f0">
test metrics:
{'max_depth': 14, 'max_leaf_nodes': 24, 'min_samples_split': 5, 'n_estimators': 27}
RandomForestClassifier(max_depth=14, max_leaf_nodes=24, min_samples_split=5,
                       n_estimators=27, random_state=42)
accuracy                                 0.9709065395409634
roc_auc                                  0.9707525940984475
precision                                0.9999794758122448
recall                                   0.9415243101182654
f1                                       0.9698719033352907

test metrics for Dummy classifier:
accuracy                                 0.5026335012110261
roc_auc                                    0.5
precision                                  0.0
recall                                     0.0
f1                                         0.0
</pre>

<p>
##+RESULTS: nov 5
</p>
<pre class="example" id="orga51bd4e">
test metrics:
{'max_depth': 12, 'max_leaf_nodes': 14, 'min_samples_split': 4, 'n_estimators': 27}
RandomForestClassifier(max_depth=12, max_leaf_nodes=14, min_samples_split=4,
                       n_estimators=27, random_state=42)
accuracy                                 0.8152992964515013
roc_auc                                  0.8156283430844639
precision                                0.7787622752746405
recall                                   0.8781015691427688
f1                                       0.8254539179087532

test metrics for Dummy classifier:
accuracy                                 0.5026335012110261
roc_auc                                    0.5
precision                                  0.0
recall                                     0.0
f1                                         0.0
</pre>
</div>
</div>
<div id="outline-container-orge35fdcc" class="outline-3">
<h3 id="orge35fdcc"><span class="section-number-3">4.10.</span> model output calibration</h3>
<div class="outline-text-3" id="text-4-10">
<p>
We uses "est_params" variable here from <a href="#org289329d">4.8</a>
</p>

<p>
We will use not over
</p>

<p>
steps:
</p>
<ol class="org-ol">
<li>use CalibratedClassifierCV that for each cv split calibrates
estimator using the testing subset.</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.preprocessing <span style="color: #8ac6f2; font-weight: bold;">import</span> MinMaxScaler
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.calibration <span style="color: #8ac6f2; font-weight: bold;">import</span> CalibrationDisplay
<span style="color: #8ac6f2; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #8ac6f2; font-weight: bold;">as</span> plt
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> train_test_split
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.ensemble <span style="color: #8ac6f2; font-weight: bold;">import</span> RandomForestClassifier
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.calibration <span style="color: #8ac6f2; font-weight: bold;">import</span> CalibratedClassifierCV
<span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.model_selection <span style="color: #8ac6f2; font-weight: bold;">import</span> StratifiedKFold
<span style="color: #fa8072;">#</span>
<span style="color: #8ac6f2; font-weight: bold;">from</span> myown_pack.common <span style="color: #8ac6f2; font-weight: bold;">import</span> load

<span style="color: #cae682;">random_state</span> = 42

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- load dataset</span>
<span style="color: #cae682;">p1</span> = <span style="color: #95e454;">'train_over.pickle'</span>
<span style="color: #cae682;">df_train</span> = load(p1)
<span style="color: #cae682;">X_train</span> = df_train.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #cae682;">y_train</span> = 1 - df_train[<span style="color: #95e454;">'tag'</span>]

<span style="color: #cae682;">p2</span> = <span style="color: #95e454;">'test.pickle'</span>
<span style="color: #cae682;">df_test</span> = load(p1)
<span style="color: #cae682;">X_test</span> = df_test.drop(columns=[<span style="color: #95e454;">'tag'</span>])
<span style="color: #cae682;">y_test</span> = 1 - df_test[<span style="color: #95e454;">'tag'</span>]

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">---- plot default and calibrated classifiers</span>
<span style="color: #cae682;">fig</span> = plt.figure(figsize=(8,6))
<span style="color: #cae682;">gs</span> = fig.add_gridspec(2,2, hspace=0.4, wspace=0.2)
<span style="color: #fa8072;">#                       </span><span style="color: #99968b; font-style: italic;">left=2.1, right=0.1, bottom=0.1, top=0.9,</span>
<span style="color: #fa8072;">#                       </span><span style="color: #99968b; font-style: italic;">wspace=0.9, hspace=0.1)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">| 1 | 2 |</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">| 3 | 4 |</span>

<span style="color: #cae682;">d1</span> = fig.add_subplot(gs[0,0])
<span style="color: #cae682;">d2</span> = fig.add_subplot(gs[0,1])
<span style="color: #cae682;">d3</span> = fig.add_subplot(gs[1,0])
<span style="color: #cae682;">d4</span> = fig.add_subplot(gs[1,1])

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">X_train, X_test, y_train, y_test = train_test_split(</span>
<span style="color: #fa8072;">#     </span><span style="color: #99968b; font-style: italic;">X, y, test_size=0.50, random_state=42, stratify=y)</span>

<span style="color: #cae682;">est_params</span> = {<span style="color: #95e454;">'max_depth'</span>: 12, <span style="color: #95e454;">'max_leaf_nodes'</span>: 14, <span style="color: #95e454;">'min_samples_split'</span>: 4, <span style="color: #95e454;">'n_estimators'</span>: 27}
est_params.update({<span style="color: #95e454;">'random_state'</span>: random_state, <span style="color: #95e454;">'n_jobs'</span>:2})
<span style="color: #cae682;">clf_default</span>: RandomForestClassifier = RandomForestClassifier(**est_params)

clf_default.fit(X_train, y_train)
<span style="color: #cae682;">y_prob</span> = clf_default.predict_proba(X_test)
<span style="color: #e5786d;">print</span>(y_prob[:,1])
d1.hist(y_prob[:,1], bins=<span style="color: #95e454;">'auto'</span>)
d1.<span style="color: #e5786d;">set</span>(title=<span style="color: #95e454;">'Before'</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">plt.show()</span>

CalibrationDisplay.from_estimator(clf_default, X_test, y_test, ax=d3)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">plt.show()</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- train calibrator</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">y_prob = MinMaxScaler().fit_transform(y_prob))</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">CalibrationDisplay.from_predictions(y_test_oneh[:,1], y_prob[:,],</span>
<span style="color: #fa8072;">#                                            </span><span style="color: #99968b; font-style: italic;">ax=d7)</span>

<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">-- calibrated:</span>
<span style="color: #cae682;">kfold</span> = StratifiedKFold(n_splits=12, random_state=random_state, shuffle=<span style="color: #e5786d; font-weight: bold;">True</span>)
<span style="color: #cae682;">cal_clf</span> = CalibratedClassifierCV(RandomForestClassifier(**est_params), method=<span style="color: #95e454;">'isotonic'</span>, <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">"sigmoid",</span>
                                 cv=kfold)
cal_clf.fit(X_train, y_train)
<span style="color: #cae682;">y_prob2</span> = cal_clf.predict_proba(X_test)
<span style="color: #e5786d;">print</span>(y_prob2[:,1])
d2.hist(y_prob2[:,1], bins=<span style="color: #95e454;">'auto'</span>)
d2.<span style="color: #e5786d;">set</span>(title=<span style="color: #95e454;">'After calibration'</span>)
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">plt.show()</span>

<span style="color: #8ac6f2; font-weight: bold;">import</span> numpy <span style="color: #8ac6f2; font-weight: bold;">as</span> np
<span style="color: #e5786d;">print</span>(y_test.size, y_test.<span style="color: #e5786d;">max</span>() + 1)
<span style="color: #cae682;">y_test_oneh</span> = np.zeros((y_test.size, <span style="color: #e5786d;">int</span>(y_test.<span style="color: #e5786d;">max</span>() + 1)))
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(y_test_oneh)</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(np.arange(y_test.size))</span>
<span style="color: #cae682;">y_test_oneh</span>[:, 1] = 1

CalibrationDisplay.from_estimator(cal_clf, X_test, y_test, ax=d4)
plt.savefig(<span style="color: #95e454;">'./autoimgs/calibrating.png'</span>)
plt.show()
plt.close()
</pre>
</div>


<div id="org0107c2b" class="figure">
<p><img src="./autoimgs/calibrating.png" alt="calibrating.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgc0f8d22" class="outline-3">
<h3 id="orgc0f8d22"><span class="section-number-3">4.11.</span> test calibrated</h3>
<div class="outline-text-3" id="text-4-11">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8ac6f2; font-weight: bold;">from</span> sklearn.metrics <span style="color: #8ac6f2; font-weight: bold;">import</span> get_scorer
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">X_test</span>
<span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">est.fit(X_train, y_train)</span>
<span style="color: #cae682;">est</span> = cal_clf
<span style="color: #8ac6f2; font-weight: bold;">for</span> k <span style="color: #8ac6f2; font-weight: bold;">in</span> [<span style="color: #95e454;">'accuracy'</span>, <span style="color: #95e454;">'roc_auc'</span>, <span style="color: #95e454;">'precision'</span>, <span style="color: #95e454;">'recall'</span>, <span style="color: #95e454;">'f1'</span>]:
    <span style="color: #cae682;">s</span> = get_scorer(k)
    <span style="color: #cae682;">y_pred</span> = est.predict(X_test)
    <span style="color: #e5786d;">print</span>(<span style="color: #95e454;">'{:40} {:5}'</span>.<span style="color: #e5786d;">format</span>(k, s._score_func(y_test, y_pred)))
    <span style="color: #fa8072;"># </span><span style="color: #99968b; font-style: italic;">print(k, s._score_func(y_test, y_pred)) # , average='binary'</span>
<span style="color: #e5786d;">print</span>()
</pre>
</div>

<pre class="example">
accuracy                                 0.9710410979970012
roc_auc                                  0.9708914087236685
precision                                0.9461049658743234
recall                                   0.9993116108306562
f1                                       0.9719806942984944
</pre>



<p>
##+RESULTS: Nov 5
</p>
<pre class="example">
accuracy                                 0.8228730152627735
roc_auc                                  0.8231424341535153
precision                                0.8612325874096038
recall                                   0.7719902095762582
f1                                       0.8141732124671028
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2023-11-17 Fri 09:52</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>